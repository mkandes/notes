# Final steps to deploy new production Spack deployments
- Remove synth benchmarks from dev stack
- Add OneAPI stack to exp/0.21.2/cpu
- Create and test build cache deployment?
- Fix hash problem?

## Fix hash problem? 

Let's try and fix the hash problem from moving back to using a `/` instead of a `-` as the delimited between the package version number and the spack hash. We'll do so with a new test `dev` deployment named `vde`. 

```
[mkandes@login02 ~]$ sudo -u spack_cpu ssh login02
PIN+Yubi: 
Welcome to Bright release         9.0

                                                         Based on Rocky Linux 8
                                                                    ID: #000002

--------------------------------------------------------------------------------

                                 WELCOME TO
                  _______  __ ____  ___    _   _______ ______
                 / ____/ |/ // __ \/   |  / | / / ___// ____/
                / __/  |   // /_/ / /| | /  |/ /\__ \/ __/
               / /___ /   |/ ____/ ___ |/ /|  /___/ / /___
              /_____//_/|_/_/   /_/  |_/_/ |_//____/_____/

--------------------------------------------------------------------------------

Use the following commands to adjust your environment:

'module avail'            - show available modules
'module add <module>'     - adds a module to your environment for this session
'module initadd <module>' - configure module to be loaded at every login

-------------------------------------------------------------------------------
Last login: Fri Dec 19 10:07:33 2025 from 198.202.100.14
[spack_cpu@login02 ~]$
```

```
[spack_cpu@login02 ~]$ !8334
srun --partition=ind-shared --reservation=root_73  --account=use300 --nodes=1 --nodelist=exp-15-56 --ntasks-per-node=1 --cpus-per-task=16 --mem=32G --time=12:00:00 --pty --wait=0 /bin/bash
[spack_cpu@exp-15-56 ~]$
```

```
[spack_cpu@exp-15-56 ~]$ cd /cm/shared/apps/spack/
[spack_cpu@exp-15-56 spack]$ ls
0.15.4  0.17.3  0.21.2  cpu  gpu
[spack_cpu@exp-15-56 spack]$ ls -lahtr
total 0
drwxr-xr-x  4 root root   2 Sep 28  2020 gpu
drwxr-xr-x  4 root root   2 Sep 28  2020 cpu
drwxr-xr-x  2 root root   2 Oct 18  2022 0.15.4
drwxr-xr-x 44 root root  43 May  3  2024 ..
drwxrwsr-x  4 root spack  2 Apr 23  2025 0.17.3
drwxrwsr-x  4 root spack  2 May 13  2025 0.21.2
drwxrwsr-x  7 root spack  5 Dec 19 06:25 .
[spack_cpu@exp-15-56 spack]$
```

```
[spack_cpu@exp-15-56 spack]$ cd 0.21.2/
[spack_cpu@exp-15-56 0.21.2]$ ls
cpu  gpu
[spack_cpu@exp-15-56 0.21.2]$ cd cpu/
[spack_cpu@exp-15-56 cpu]$ ls
dev
[spack_cpu@exp-15-56 cpu]$ ls -lahtr
total 0
drwxr-sr-x  3 spack_cpu spack  1 May  7  2025 .
drwxrwsr-x  4 root      spack  2 May 13  2025 ..
drwxr-sr-x 10 spack_cpu spack 27 Dec 19 10:08 dev
[spack_cpu@exp-15-56 cpu]$
```

Write access to `/cm/shared/apps/spack` lost again - likely due to node reboot.

```
[spack_cpu@exp-15-56 spack]$ cd 0.21.2/cpu/dev/
[spack_cpu@exp-15-56 dev]$ ls
bin           COPYRIGHT  LICENSE-APACHE  opt             README.md    test
CHANGELOG.md  etc        LICENSE-MIT     pyproject.toml  SECURITY.md  var
CITATION.cff  lib        NOTICE          pytest.ini      share
[spack_cpu@exp-15-56 dev]$ touch test
touch: setting times of 'test': Permission denied
[spack_cpu@exp-15-56 dev]$ pwd
/cm/shared/apps/spack/0.21.2/cpu/dev
[spack_cpu@exp-15-56 dev]$
```

# Move to testing out of HOME dir again?

```
[mkandes@login02 repos]$ cd sdsc/
[mkandes@login02 sdsc]$ ls
spack
[mkandes@login02 sdsc]$ rm -rf spack/
[mkandes@login02 sdsc]$ git clone https://github.com/sdsc/spack.git
Cloning into 'spack'...
remote: Enumerating objects: 627245, done.
remote: Total 627245 (delta 0), reused 0 (delta 0), pack-reused 627245 (from 1)
Receiving objects: 100% (627245/627245), 458.78 MiB | 861.00 KiB/s, done.
Resolving deltas: 100% (292298/292298), done.
Updating files: 100% (12669/12669), done.
[mkandes@login02 sdsc]$ ls
spack
[mkandes@login02 sdsc]$ cd spack/
[mkandes@login02 spack]$ ls
activate-shared-spack-instance.sh   COPYRIGHT       NOTICE          share
bin                                 etc             pyproject.toml  var
CHANGELOG.md                        lib             pytest.ini
CITATION.cff                        LICENSE-APACHE  README.md
configure-shared-spack-instance.sh  LICENSE-MIT     SECURITY.md
[mkandes@login02 spack]$ cd etc/spack/
defaults/ sdsc/     
[mkandes@login02 spack]$ cd etc/spack/
[mkandes@login02 spack]$ ls
defaults  repos.yaml  sdsc
[mkandes@login02 spack]$ cd sdsc/
[mkandes@login02 sdsc]$ ls
exp
[mkandes@login02 sdsc]$ cd exp/
cpu/ gpu/ 
[mkandes@login02 sdsc]$ cd exp/cpu/dev/
[mkandes@login02 dev]$ ls
deploy.o39203939.exp-15-56  deploy.o39336070.exp-15-56  deploy.sh  specs  yamls
[mkandes@login02 dev]$ ls -lahtr
total 89K
drwxr-xr-x 3 mkandes use300   3 Jan 29 20:24 ..
-rw-r--r-- 1 mkandes use300 53K Jan 29 20:24 deploy.o39203939.exp-15-56
-rw-r--r-- 1 mkandes use300 56K Jan 29 20:24 deploy.o39336070.exp-15-56
-rw-r--r-- 1 mkandes use300 36K Jan 29 20:24 deploy.sh
drwxr-xr-x 4 mkandes use300  70 Jan 29 20:25 specs
drwxr-xr-x 4 mkandes use300   7 Jan 29 20:25 .
drwxr-xr-x 2 mkandes use300   5 Jan 29 20:25 yamls
[mkandes@login02 dev]$ less deploy.sh
[mkandes@login02 dev]$ less deploy.o39336070.exp-15-56
[mkandes@login02 dev]$ cp deploy.sh deploy-test.sh
[mkandes@login02 dev]$ vi deploy-test.sh 
[mkandes@login02 dev]$ cd yamls/
[mkandes@login02 yamls]$ ls
compilers.yaml  modules.yaml  packages.yaml
[mkandes@login02 yamls]$ vi modules.yaml 
[mkandes@login02 yamls]$ cd ../
[mkandes@login02 dev]$ ls
deploy.o39203939.exp-15-56  deploy.o39336070.exp-15-56  deploy.sh  deploy-test.sh  specs  yamls
[mkandes@login02 dev]$ mv deploy-test.sh deploy.sh 
[mkandes@login02 dev]$ vi deploy.sh 
[mkandes@login02 dev]$ sbatch deploy.sh 
Submitted batch job 46132028 on cluster expanse
[mkandes@login02 dev]$ squeue -u $USER
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
          46131642     debug build-la  mkandes  R      16:45      1 exp-9-55
          46132040 ind-share git@2.45  mkandes PD       0:00      1 (Dependency)
          46132039 ind-share entrezdi  mkandes PD       0:00      1 (Dependency)
          46132038 ind-share perl@5.3  mkandes PD       0:00      1 (Dependency)
          46132037 ind-share mercuria  mkandes PD       0:00      1 (Dependency)
          46132036 ind-share gdb@14.2  mkandes PD       0:00      1 (Dependency)
          46132035 ind-share aria2@1.  mkandes PD       0:00      1 (Dependency)
          46132034 ind-share sqlite@3  mkandes PD       0:00      1 (Dependency)
          46132033 ind-share gcc@13.3  mkandes PD       0:00      1 (Dependency)
          46132032 ind-share cmake@3.  mkandes PD       0:00      1 (Dependency)
          46132031 ind-share aocc@4.2  mkandes PD       0:00      1 (Dependency)
          46132030 ind-share curl@8.4  mkandes PD       0:00      1 (Dependency)
          46132029 ind-share bzip2@1.  mkandes  R       0:01      1 exp-15-56
          46132028 ind-share   deploy  mkandes  R       0:02      1 exp-15-36
[mkandes@login02 dev]$
```
