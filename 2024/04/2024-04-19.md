# Developing a new Spack instance

To begin the development of a new Spack instance that will be merged into one of SDSC's deployment branches, login into the HPC system where the new instance will be developed, tested, and, eventually, deployed. 

```
mkandes@hardtack:~$ ssh mkandes@login.expanse.sdsc.edu
Welcome to Bright release         9.0

                                                         Based on Rocky Linux 8
                                                                    ID: #000002

--------------------------------------------------------------------------------

                                 WELCOME TO
                  _______  __ ____  ___    _   _______ ______
                 / ____/ |/ // __ \/   |  / | / / ___// ____/
                / __/  |   // /_/ / /| | /  |/ /\__ \/ __/
               / /___ /   |/ ____/ ___ |/ /|  /___/ / /___
              /_____//_/|_/_/   /_/  |_/_/ |_//____/_____/

--------------------------------------------------------------------------------

Use the following commands to adjust your environment:

'module avail'            - show available modules
'module add <module>'     - adds a module to your environment for this session
'module initadd <module>' - configure module to be loaded at every login

-------------------------------------------------------------------------------
Last login: Thu Apr 18 07:32:18 2024 from 208.58.212.11
[mkandes@login02 ~]$
```

If you do not have a copy of your personal fork of the sdsc/spack repository on this system, then clone the fork to your HOME directory.

```
[mkandes@login02 ~]$ cd software/spack/
[mkandes@login02 spack]$ ls
releases  repositories
[mkandes@login02 spack]$ cd repositories/
[mkandes@login02 repositories]$ ls
sdsc  spack
[mkandes@login02 repositories]$ mkdir mkandes
[mkandes@login02 repositories]$ cd mkandes/
[mkandes@login02 mkandes]$ git clone https://github.com/mkandes/spack.git
Cloning into 'spack'...
remote: Enumerating objects: 563831, done.
remote: Total 563831 (delta 0), reused 0 (delta 0), pack-reused 563831
Receiving objects: 100% (563831/563831), 241.70 MiB | 38.24 MiB/s, done.
Resolving deltas: 100% (260856/260856), done.
Updating files: 100% (12424/12424), done.
[mkandes@login02 mkandes]$
```

Once your fork is cloned, enter the top-level directory of the repository and check that the current default branch in your fork is the deployment branch to which the new instance should be added.

```
[mkandes@login02 mkandes]$ cd spack/
[mkandes@login02 spack]$ git branch
* sdsc-0.17.3
[mkandes@login02 spack]$
```

If it is, then before you proceed make sure to fetch any changes and resync your copy of the deployment branch with the sdsc/spack upstream repository. 

```
[mkandes@login02 spack]$ git remote -v
origin	https://github.com/mkandes/spack.git (fetch)
origin	https://github.com/mkandes/spack.git (push)
[mkandes@login02 spack]$ git remote add upstream https://github.com/sdsc/spack.git
[mkandes@login02 spack]$ git remote -v
origin	https://github.com/mkandes/spack.git (fetch)
origin	https://github.com/mkandes/spack.git (push)
upstream	https://github.com/sdsc/spack.git (fetch)
upstream	https://github.com/sdsc/spack.git (push)
[mkandes@login02 spack]$ git fetch upstream
remote: Enumerating objects: 16388, done.
remote: Counting objects: 100% (4993/4993), done.
remote: Total 16388 (delta 4993), reused 4993 (delta 4993), pack-reused 11395
Receiving objects: 100% (16388/16388), 196.24 MiB | 28.61 MiB/s, done.
Resolving deltas: 100% (9867/9867), completed with 1190 local objects.
From https://github.com/sdsc/spack
 * [new branch]            FASTMath/ATPESC18                     -> upstream/FASTMath/ATPESC18
 * [new branch]            FASTMath/ATPESC19                     -> upstream/FASTMath/ATPESC19
 * [new branch]            PR/openblas                           -> upstream/PR/openblas
 * [new branch]            PR/pymock                             -> upstream/PR/pymock
 * [new branch]            add-miniconda3@4.8.2-and-revert-4.7.12.1 -> upstream/add-miniconda3@4.8.2-and-revert-4.7.12.1
 * [new branch]            amklinv/amanzi                        -> upstream/amklinv/amanzi
 * [new branch]            ascent                                -> upstream/ascent
 * [new branch]            autotools-cflags                      -> upstream/autotools-cflags
 * [new branch]            barry/ceed                            -> upstream/barry/ceed
 * [new branch]            boost-intel-toolset                   -> upstream/boost-intel-toolset
 * [new branch]            bugfix/buildable-true-override-virtual -> upstream/bugfix/buildable-true-override-virtual
 * [new branch]            bugfix/bz2-libs                       -> upstream/bugfix/bz2-libs
 * [new branch]            bugfix/compare-abstract-specs         -> upstream/bugfix/compare-abstract-specs
 * [new branch]            bugfix/cray-no-module-preloaded       -> upstream/bugfix/cray-no-module-preloaded
 * [new branch]            bugfix/env-activate-only-installed-concrete-specs -> upstream/bugfix/env-activate-only-installed-concrete-specs
 * [new branch]            bugfix/improved-uid-detection         -> upstream/bugfix/improved-uid-detection
 * [new branch]            bugfix/m4_sierra_gcc_2                -> upstream/bugfix/m4_sierra_gcc_2
 * [new branch]            bugfix/multiarch-detection            -> upstream/bugfix/multiarch-detection
 * [new branch]            bugfix/ordered-compiler-names         -> upstream/bugfix/ordered-compiler-names
 * [new branch]            bugfix/sbang-filter-non-ascii-python-3 -> upstream/bugfix/sbang-filter-non-ascii-python-3
 * [new branch]            bugfix/setup-env                      -> upstream/bugfix/setup-env
 * [new branch]            bugfix/shasta-hotfix-live-branch      -> upstream/bugfix/shasta-hotfix-live-branch
 * [new branch]            bugfix/target-args-cray-compilers     -> upstream/bugfix/target-args-cray-compilers
 * [new branch]            cdash/xsdk                            -> upstream/cdash/xsdk
 * [new branch]            chain-doc-minor-improvement           -> upstream/chain-doc-minor-improvement
 * [new branch]            concretizer                           -> upstream/concretizer
 * [new branch]            cray-libsci-and-ver                   -> upstream/cray-libsci-and-ver
 * [new branch]            dependabot/github_actions/actions/setup-python-4.6.0 -> upstream/dependabot/github_actions/actions/setup-python-4.6.0
 * [new branch]            dependabot/github_actions/docker/build-push-action-4.0.0 -> upstream/dependabot/github_actions/docker/build-push-action-4.0.0
 * [new branch]            dependabot/github_actions/docker/login-action-2.1.0 -> upstream/dependabot/github_actions/docker/login-action-2.1.0
 * [new branch]            dependabot/github_actions/docker/setup-buildx-action-2.5.0 -> upstream/dependabot/github_actions/docker/setup-buildx-action-2.5.0
 * [new branch]            dependabot/github_actions/docker/setup-qemu-action-2.1.0 -> upstream/dependabot/github_actions/docker/setup-qemu-action-2.1.0
 * [new branch]            develop                               -> upstream/develop
 * [new branch]            docs/environment-scopes               -> upstream/docs/environment-scopes
 * [new branch]            documentation/asp_based_solver        -> upstream/documentation/asp_based_solver
 * [new branch]            eaf/200402-SpackEnvironmentDocs       -> upstream/eaf/200402-SpackEnvironmentDocs
 * [new branch]            efischer/190121-SetupEnv              -> upstream/efischer/190121-SetupEnv
 * [new branch]            efischer/190923-MultiPackagePrototype -> upstream/efischer/190923-MultiPackagePrototype
 * [new branch]            efischer/docs2                        -> upstream/efischer/docs2
 * [new branch]            features/add-buildcache-list-to-database -> upstream/features/add-buildcache-list-to-database
 * [new branch]            features/anonymous_specs-fix          -> upstream/features/anonymous_specs-fix
 * [new branch]            features/arch-swapping                -> upstream/features/arch-swapping
 * [new branch]            features/cached-cmake-build-system    -> upstream/features/cached-cmake-build-system
 * [new branch]            features/cflags-resuse                -> upstream/features/cflags-resuse
 * [new branch]            features/cmake_deps                   -> upstream/features/cmake_deps
 * [new branch]            features/compil                       -> upstream/features/compil
 * [new branch]            features/detect-and-swap-current-python -> upstream/features/detect-and-swap-current-python
 * [new branch]            features/env-improvements-release     -> upstream/features/env-improvements-release
 * [new branch]            features/env-pre-cmd                  -> upstream/features/env-pre-cmd
 * [new branch]            features/find-linux-compilers-by-module -> upstream/features/find-linux-compilers-by-module
 * [new branch]            features/fix-cc-wrapper               -> upstream/features/fix-cc-wrapper
 * [new branch]            features/improved-python-detection    -> upstream/features/improved-python-detection
 * [new branch]            features/libs-command                 -> upstream/features/libs-command
 * [new branch]            features/make-platform-command-line-option -> upstream/features/make-platform-command-line-option
 * [new branch]            features/more-coverage                -> upstream/features/more-coverage
 * [new branch]            features/multi-download               -> upstream/features/multi-download
 * [new branch]            features/parallel-mirror              -> upstream/features/parallel-mirror
 * [new branch]            features/rstudio                      -> upstream/features/rstudio
 * [new branch]            features/sandbox-builds               -> upstream/features/sandbox-builds
 * [new branch]            features/setup_py                     -> upstream/features/setup_py
 * [new branch]            features/shebang-warning-to-msg       -> upstream/features/shebang-warning-to-msg
 * [new branch]            features/solver                       -> upstream/features/solver
 * [new branch]            features/spack-mirror-verify          -> upstream/features/spack-mirror-verify
 * [new branch]            features/spack-test-add-show-subcommand -> upstream/features/spack-test-add-show-subcommand
 * [new branch]            features/spack-test-hdf5-fix          -> upstream/features/spack-test-hdf5-fix
 * [new branch]            features/spack-test-openmpi           -> upstream/features/spack-test-openmpi
 * [new branch]            features/spack-test-openmpi-add-tests -> upstream/features/spack-test-openmpi-add-tests
 * [new branch]            features/stat_coral_test              -> upstream/features/stat_coral_test
 * [new branch]            features/tty-output                   -> upstream/features/tty-output
 * [new branch]            features/view-with-env                -> upstream/features/view-with-env
 * [new branch]            features/virtual-packages             -> upstream/features/virtual-packages
 * [new branch]            fish-shell-1                          -> upstream/fish-shell-1
 * [new branch]            fix_cc                                -> upstream/fix_cc
 * [new branch]            flake8-sha256                         -> upstream/flake8-sha256
 * [new branch]            fugaku-cross-compilation              -> upstream/fugaku-cross-compilation
 * [new branch]            gh-pages                              -> upstream/gh-pages
 * [new branch]            github/pr_templates                   -> upstream/github/pr_templates
 * [new branch]            implicit-variables-setup              -> upstream/implicit-variables-setup
 * [new branch]            legion-update                         -> upstream/legion-update
 * [new branch]            libfabric-191-seems-to-work-on-darwin -> upstream/libfabric-191-seems-to-work-on-darwin
 * [new branch]            mfem                                  -> upstream/mfem
 * [new branch]            mfem-updates                          -> upstream/mfem-updates
 * [new branch]            mfu-cmake                             -> upstream/mfu-cmake
 * [new branch]            mpbelhorn-aomp-3.9.0-wip-patch        -> upstream/mpbelhorn-aomp-3.9.0-wip-patch
 * [new branch]            package/archer                        -> upstream/package/archer
 * [new branch]            packages/gsl-external-cblas           -> upstream/packages/gsl-external-cblas
 * [new branch]            packages/pruners-mpi                  -> upstream/packages/pruners-mpi
 * [new branch]            packages/tulip                        -> upstream/packages/tulip
 * [new branch]            parse-oneapi-version                  -> upstream/parse-oneapi-version
 * [new branch]            pipelines-fix-develop-ambiguity       -> upstream/pipelines-fix-develop-ambiguity
 * [new branch]            pipelines-improve-ci-job-label        -> upstream/pipelines-improve-ci-job-label
 * [new branch]            proto/sys-packages-old                -> upstream/proto/sys-packages-old
 * [new branch]            py-cffi-fix-checksum                  -> upstream/py-cffi-fix-checksum
 * [new branch]            py26-bootstrap                        -> upstream/py26-bootstrap
 * [new branch]            release_pipeline                      -> upstream/release_pipeline
 * [new branch]            releases/v0.10.0                      -> upstream/releases/v0.10.0
 * [new branch]            releases/v0.11.0                      -> upstream/releases/v0.11.0
 * [new branch]            releases/v0.11.1                      -> upstream/releases/v0.11.1
 * [new branch]            releases/v0.11.2                      -> upstream/releases/v0.11.2
 * [new branch]            releases/v0.12                        -> upstream/releases/v0.12
 * [new branch]            releases/v0.13                        -> upstream/releases/v0.13
 * [new branch]            releases/v0.13-hwlloc-master          -> upstream/releases/v0.13-hwlloc-master
 * [new branch]            releases/v0.14                        -> upstream/releases/v0.14
 * [new branch]            releases/v0.15                        -> upstream/releases/v0.15
 * [new branch]            releases/v0.16                        -> upstream/releases/v0.16
 * [new branch]            retry_serial                          -> upstream/retry_serial
 * [new branch]            revert-4.7.12.1                       -> upstream/revert-4.7.12.1
 * [new branch]            sdsc-0.15.4                           -> upstream/sdsc-0.15.4
 * [new branch]            sdsc-0.17.1                           -> upstream/sdsc-0.17.1
 * [new branch]            sdsc-0.17.2                           -> upstream/sdsc-0.17.2
 * [new branch]            sdsc-0.17.3                           -> upstream/sdsc-0.17.3
 * [new branch]            sdsc-0.18.0                           -> upstream/sdsc-0.18.0
 * [new branch]            sdsc-0.19.1                           -> upstream/sdsc-0.19.1
 * [new branch]            separate-wrapper-decorator            -> upstream/separate-wrapper-decorator
 * [new branch]            shorten-install-status-help           -> upstream/shorten-install-status-help
 * [new branch]            silo-qt4                              -> upstream/silo-qt4
 * [new branch]            spacktivate                           -> upstream/spacktivate
 * [new branch]            spec-language-ideas                   -> upstream/spec-language-ideas
 * [new branch]            spec-parse-inequalities               -> upstream/spec-parse-inequalities
 * [new branch]            spec-target-flag-option               -> upstream/spec-target-flag-option
 * [new branch]            stacks-debugging                      -> upstream/stacks-debugging
 * [new branch]            test-gitlab-check-stays-pending       -> upstream/test-gitlab-check-stays-pending
 * [new branch]            test/v0.13-with-fast-environments     -> upstream/test/v0.13-with-fast-environments
 * [new branch]            testing/wip_xsdk                      -> upstream/testing/wip_xsdk
 * [new branch]            tests/vtk-m-smoke-test-fix            -> upstream/tests/vtk-m-smoke-test-fix
 * [new branch]            topic-libSplash160                    -> upstream/topic-libSplash160
 * [new branch]            tutorials/advanced_packaging          -> upstream/tutorials/advanced_packaging
 * [new branch]            update/ipopt                          -> upstream/update/ipopt
 * [new branch]            v-dobrev/extend-default-spec-queries  -> upstream/v-dobrev/extend-default-spec-queries
 * [new branch]            vendor-clingo                         -> upstream/vendor-clingo
 * [new branch]            z3-bootstrap-2.6                      -> upstream/z3-bootstrap-2.6
 * [new branch]            z3-concretizer                        -> upstream/z3-concretizer
[mkandes@login02 spack]$ git push
Username for 'https://github.com': mkandes
Password for 'https://mkandes@github.com': 
Everything up-to-date
[mkandes@login02 spack]$
```

Now create a new branch where the new Spack instance will be developed and tested prior to submitting it back as a pull request to be merged into the upstream sdsc/spack repository. 

```
[mkandes@login02 spack]$ git branch
* sdsc-0.17.3
  sdsc-0.17.3-gh-124-inst-exp-cpu-dev
[mkandes@login02 spack]$
```

Then checkout the new branch and start development of the new instance.

```
[mkandes@login02 spack]$ git checkout sdsc-0.17.3-gh-124-inst-exp-cpu-dev
Switched to branch 'sdsc-0.17.3-gh-124-inst-exp-cpu-dev'
[mkandes@login02 spack]$ git branch
  sdsc-0.17.3
* sdsc-0.17.3-gh-124-inst-exp-cpu-dev
[mkandes@login02 spack]$
```

Here, in this case, we want to create development versions of the latest existing production Spack instances on Expanse, namely, `expanse/0.17.3/cpu/b` and `expanse/0.17.3/gpu/b`. These instances will allow us to more quickly test system changes and their possible affects on the already depolyed production Spack instances. In addition, they will serve as the basis of all new Spack instances moving forward as we update to newer versions of Spack. The inention here is to pull out of the poroduction instances all of the benchmark applications we used as part of acceptance testing for Expanse. We'll create this new subset of instances as special versions of the named `cpu` and `gpu` production instances, where they will be labelled by `SPACK_INSTANCE_VERSION='dev'`. 

```
[mkandes@login02 spack]$ ls
activate-shared-spack-instance.sh   CONTRIBUTING.md  lib             pyproject.toml  share
bin                                 COPYRIGHT        LICENSE-APACHE  pytest.ini      var
CHANGELOG.md                        DEPLOYMENT.md    LICENSE-MIT     README.md
configure-shared-spack-instance.sh  etc              NOTICE          SECURITY.md
[mkandes@login02 spack]$ cd etc/spack/sdsc/
[mkandes@login02 sdsc]$ ls
expanse  tscc
[mkandes@login02 sdsc]$ cd expanse/
[mkandes@login02 expanse]$ ls
0.17.3
[mkandes@login02 expanse]$ cd 0.17.3/
[mkandes@login02 0.17.3]$ ls
cpu  gpu
[mkandes@login02 0.17.3]$ cd cpu/
[mkandes@login02 cpu]$ ls
b
[mkandes@login02 cpu]$ mkdir dev
[mkandes@login02 cpu]$
```

With the new subdirectory for the `cpu/dev` instance created, we can start replicating the production `cpu/b` instance by making a copy of its `*.yaml` configuration files. 

```
[mkandes@login02 cpu]$ ls
b  dev
[mkandes@login02 cpu]$ ls b/
specs  SPECS.md  yamls
[mkandes@login02 cpu]$ cp -rp b/yamls/ dev/yamls
[mkandes@login02 cpu]$ cd dev/yamls/
[mkandes@login02 yamls]$ ls
compilers.yaml  modules.yaml  packages.yaml
[mkandes@login02 yamls]$
```

Next, we'll reinitialize the configuration files by removing all entires that are either not necessary for a base Spack instance and/or this `dev` instance. Starting with the `compilers.yaml` file, remove all compilers, except the `gcc` compiler from the operating system, which will serve as the base compiler upon which the instance will be boostraped. 

```
[mkandes@login02 yamls]$ cat compilers.yaml 
compilers:
- compiler:
    spec: gcc@8.5.0
    paths:
      cc: /usr/bin/gcc
      cxx: /usr/bin/g++
      f77: /usr/bin/gfortran
      fc: /usr/bin/gfortran
    flags:
      cflags: -O2 -march=native
      cxxflags: -O2 -march=native
      fflags: -O2 -march=native
    operating_system: rocky8
    target: x86_64
    modules: []
    environment: {}
    extra_rpaths: []
- compiler:
    spec: gcc@10.2.0
    paths:
      cc: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/gcc-10.2.0-npcyll4gxjhf4tejksmdzlsl3d3usqpd/bin/gcc
      cxx: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/gcc-10.2.0-npcyll4gxjhf4tejksmdzlsl3d3usqpd/bin/g++
      f77: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/gcc-10.2.0-npcyll4gxjhf4tejksmdzlsl3d3usqpd/bin/gfortran
      fc: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/gcc-10.2.0-npcyll4gxjhf4tejksmdzlsl3d3usqpd/bin/gfortran
    flags:
      cflags: -O2 -march=native
      cxxflags: -O2 -march=native
      fflags: -O2 -march=native
    operating_system: rocky8
    target: x86_64
    modules: []
    environment: {}
    extra_rpaths: []
- compiler:
    spec: aocc@3.2.0
    paths:
      cc: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/aocc-3.2.0-io3s466wsnnichqc2o2rikbuloev5bmq/bin/clang
      cxx: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/aocc-3.2.0-io3s466wsnnichqc2o2rikbuloev5bmq/bin/clang++
      f77: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/aocc-3.2.0-io3s466wsnnichqc2o2rikbuloev5bmq/bin/flang
      fc: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/aocc-3.2.0-io3s466wsnnichqc2o2rikbuloev5bmq/bin/flang
    flags:
      cflags: -O2 -march=native
      cxxflags: -O2 -march=native
      fflags: -O2 -march=native
    operating_system: rocky8
    target: x86_64
    modules: []
    environment: {}
    extra_rpaths: []
- compiler:
    spec: intel@19.1.3.304
    paths:
      cc: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/intel-19.1.3.304-6pv46sozip5o35ezrswc4p77gsiawktn/bin/icc
      cxx: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/intel-19.1.3.304-6pv46sozip5o35ezrswc4p77gsiawktn/bin/icpc
      f77: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/intel-19.1.3.304-6pv46sozip5o35ezrswc4p77gsiawktn/bin/ifort
      fc: /cm/shared/apps/spack/0.17.3/cpu/b/opt/spack/linux-rocky8-zen/gcc-8.5.0/intel-19.1.3.304-6pv46sozip5o35ezrswc4p77gsiawktn/bin/ifort
    flags:
      cflags: -O2 -march=native
      cxxflags: -O2 -march=native
      fflags: -O2 -march=native
    operating_system: rocky8
    target: x86_64
    modules: []
    environment: {}
    extra_rpaths: []
[mkandes@login02 yamls]$ which gcc
/usr/bin/gcc
[mkandes@login02 yamls]$ gcc --version
gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18)
Copyright (C) 2018 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

[mkandes@login02 yamls]$ vi compilers.yaml 
[mkandes@login02 yamls]$ cat compilers.yaml 
compilers:
- compiler:
    spec: gcc@8.5.0
    paths:
      cc: /usr/bin/gcc
      cxx: /usr/bin/g++
      f77: /usr/bin/gfortran
      fc: /usr/bin/gfortran
    flags:
      cflags: -O2 -march=native
      cxxflags: -O2 -march=native
      fflags: -O2 -march=native
    operating_system: rocky8
    target: x86_64
    modules: []
    environment: {}
    extra_rpaths: []
[mkandes@login02 yamls]$
```

The `modules.yaml` configruation file could likely remain as-is. However, we would also like to implement a few changes to the module enviornment on Expanse moving forward, both cosmetic and pratical. For example, the major change here will be to use a dash instead of a slash between a package's version number and the Spack hash. This is the format currently in use on TSCC and will remove the requirement that users explicitly specify the version when loading a module. This may also help with reducing the maintanence on the latest version of the example batch job scripts provided for users.

```
[mkandes@login02 yamls]$ cat modules.yaml 
modules:
  default:
    enable::
      - lmod
    lmod:
      core_compilers:
        - 'gcc@8.5.0'
      hierarchy:
        - mpi
      hash_length: 0
      blacklist_implicits: true
      whitelist: ['py-jupyter-core', 'hadoop']
      naming_scheme: '{name}/{version}/{hash:7}'
      projections:
        all: '{name}/{version}/{hash:7}'
      all:
        suffixes:
          '+openmp': omp
          'threads=openmp': omp
          '+ipl64': i64
        environment:
          set:
            '{name}HOME': '{prefix}'
      intel:
        environment:
          set:
            INTEL_LICENSE_FILE: '40000@elprado.sdsc.edu:40200@elprado.sdsc.edu'
      petsc:
        suffixes:
          '+complex': cmplx
      slepc:
        suffixes:
          '^petsc +complex': cmplx
      ^python:
        autoload: 'direct'
      ^ucx:
        autoload: 'direct'
[mkandes@login02 yamls]$ vi modules.yaml 
[mkandes@login02 yamls]$ cat modules.yaml 
modules:
  default:
    enable::
      - lmod
    lmod:
      core_compilers:
        - 'gcc@8.5.0'
      hierarchy:
        - mpi
      hash_length: 0
      blacklist_implicits: true
      naming_scheme: '{name}/{version}-{hash:7}'
      projections:
        all: '{name}/{version}-{hash:7}'
      all:
        suffixes:
          '+openmp': omp
          'threads=openmp': omp
          '+ipl64': i64
        environment:
          set:
            '{name}_ROOT': '{prefix}'
      intel:
        environment:
          set:
            INTEL_LICENSE_FILE: '40000@elprado.sdsc.edu:40200@elprado.sdsc.edu'
      petsc:
        suffixes:
          '+complex': cmplx
      slepc:
        suffixes:
          '^petsc +complex': cmplx
      ^python:
        autoload: 'direct'
      ^ucx:
        autoload: 'direct'
[mkandes@login02 yamls]$
```

Similarly, we'll clean up the `packages.yaml` configuration file to only include the essential external packages required for the `dev` instances and update them as needed to reflect their current state on Expanse.

```
[mkandes@login02 yamls]$ cat packages.yaml 
packages:
  lmod:
    externals:
      - spec: 'lmod@8.2.4'
        prefix: /usr
    buildable: false
  lustre:
    externals:
      - spec: 'lustre@2.15.2'
        prefix: /usr
    buildable: false
  openssl:
    externals:
      - spec: 'openssl@1.1.1k'
        prefix: /usr
    buildable: false
  rdma-core:
    externals:
      - spec: 'rdma-core@43.0'
        prefix: /usr
    buildable: false
  slurm:
    externals:
      - spec: 'slurm@21.08.8'
        prefix: /cm/shared/apps/slurm/21.08.8
    buildable: false
  librsvg:
    externals:
      - spec: 'librsvg@2.42.7'
        prefix: /usr
    buildable: false
  ghostscript:
    externals:
      - spec: 'ghostscript@9.27'
        prefix: /usr
    buildable: false
  gaussian:
    permissions:
      read: group
      group: gaussian
  vasp6:
    permissions:
      read: group
      group: vasp-6

[mkandes@login02 yamls]$ module --version

Modules based on Lua: Version 8.2.4  2019-11-14 12:45 -06:00
    by Robert McLay mclay@tacc.utexas.edu

[mkandes@login02 yamls]$ lfs --version
lfs 2.15.2
[mkandes@login02 yamls]$ openssl
OpenSSL> version
OpenSSL 1.1.1k  FIPS 25 Mar 2021
OpenSSL> exit
[mkandes@login02 yamls]$ find /usr -name 'librdma*'
/usr/share/doc/librdmacm
/usr/share/doc/librdmacm/librdmacm.md
find: ‘/usr/share/polkit-1/rules.d’: Permission denied
find: ‘/usr/share/selinux/targeted/default/active’: Permission denied
find: ‘/usr/libexec/initscripts/legacy-actions/auditd’: Permission denied
/usr/lib64/librdmacm.so.1.3.43.0
/usr/lib64/pkgconfig/librdmacm.pc
/usr/lib64/librdmacm.a
/usr/lib64/librdmacm.so.1
/usr/lib64/librdmacm.so
find: ‘/usr/lib64/security/pam_bright’: Permission denied
[mkandes@login02 yamls]$ sbatch --version
slurm 23.02.7
[mkandes@login02 yamls]$ which sbatch
/cm/shared/apps/slurm/current/bin/sbatch
[mkandes@login02 yamls]$ ls -lahtr $(which sbatch)
-rwxr-xr-x 1 root root 444K Dec 17 10:03 /cm/shared/apps/slurm/current/bin/sbatch
[mkandes@login02 yamls]$ ls -lahtr /cm/shared/apps/slurm
total 512
drwxr-xr-x  5 root root  3 Aug 26  2020 var
drwxr-xr-x  3 root root  6 Sep 28  2020 slurmctld_stats
drwxr-xr-x  3 root root  5 Aug 11  2021 jobstate
drwxr-xr-x  2 root root  6 May 12  2022 scripts
drwxr-xr-x  3 root root  6 Oct 24  2022 nodestate
drwxr-xr-x 43 root root 42 Apr 14  2023 ..
drwxr-xr-x  7 root root  5 Dec 18 08:59 21.08.8
drwxr-xr-x  8 root root  6 Feb 12 09:00 23.02.7
drwxr-xr-x  7 root root  5 Feb 12 09:00 23.02.6
lrwxrwxrwx  1 root root  7 Feb 12 09:02 current -> 23.02.7
drwxr-xr-x 10 root root  9 Feb 12 09:02 .
[mkandes@login02 yamls]$ find /usr -name 'librsvg*'
/usr/share/licenses/librsvg2
/usr/share/thumbnailers/librsvg.thumbnailer
/usr/share/doc/librsvg2
find: ‘/usr/share/polkit-1/rules.d’: Permission denied
find: ‘/usr/share/selinux/targeted/default/active’: Permission denied
find: ‘/usr/libexec/initscripts/legacy-actions/auditd’: Permission denied
/usr/lib64/librsvg-2.so.2.42.7
/usr/lib64/librsvg-2.so.2
find: ‘/usr/lib64/security/pam_bright’: Permission denied
[mkandes@login02 yamls]$ gs --version
9.27
[mkandes@login02 yamls]$ vi packages.yaml 
[mkandes@login02 yamls]$ cat packages.yaml 
packages:
  lmod:
    externals:
      - spec: 'lmod@8.2.4'
        prefix: /usr
    buildable: false
  lustre:
    externals:
      - spec: 'lustre@2.15.2'
        prefix: /usr
    buildable: false
  openssl:
    externals:
      - spec: 'openssl@1.1.1k'
        prefix: /usr
    buildable: false
  rdma-core:
    externals:
      - spec: 'rdma-core@43.0'
        prefix: /usr
    buildable: false
  slurm:
    externals:
      - spec: 'slurm@23.02.7'
        prefix: /cm/shared/apps/slurm/current
    buildable: false
[mkandes@login02 yamls]$
```

Now that we have the configruation files ready to begin developing the `cpu/dev` instance, let's try and plan out an initial deployment by creating a pared down version of the SPECS.md file. 

```
[mkandes@login02 dev]$ cat SPECS.md 
# expanse/0.17.3/cpu


| Core (gcc@8.5.0)           |
| -------------------------- |
| parallel@20210922          |
| pigz@2.6                   |
| git@2.31.1                 |
| git-lfs@2.11.0             |
| gh@2.0.0                   |
| subversion@1.14.0          |
| mercurial@5.8              |
| aria2@1.35.0               |
| rclone@1.56.2              |
| sratoolkit@2.10.9          |
| entrezdirect@10.7.20190114 |
| anaconda3@2021.05          |
| matlab@2022b               | 



| gcc@10.2.0               | openmpi@4.1.3              | openmpi@3.1.6              | intel-mpi@2019.10.317      | mvapich2@2.3.7             | openmpi@4.1.1 |
| ------------------------ | -------------------------- | -------------------------- | -------------------------- | -------------------------- | ------------- |
| cmake@3.21.4             | hpl@2.3                    | hpl@2.3                    | hpl@2.3                    | hpl@2.3                    | orca@5.0.4    |
| perl@5.32.0              | hpl@2.3-omp                | hpl@2.3-omp                | hpl@2.3-omp                | hpl@2.3-omp                |
| tcl@8.6.11               | osu-micro-benchmarks@5.7.1 | osu-micro-benchmarks@5.7.1 | osu-micro-benchmarks@5.7.1 | osu-micro-benchmarks@5.7.1 |
| tcl@8.5.9                | netlib-scalapack@2.1.0     | netlib-scalapack@2.1.0     | netlib-scalapack@2.1.0     | netlib-scalapack@2.1.0     |
| sqlite@3.36.0            | fftw@3.3.10                | fftw@3.3.10                | fftw@3.3.10                | fftw@3.3.10                |
| python@3.8.12            | hdf5@1.10.7                | hdf5@1.10.7                | hdf5@1.10.7                | hdf5@1.10.7                |
| py-setuptools@58.2.0     | parmetis@4.0.3             | parmetis@4.0.3             | parmetis@4.0.3             | parmetis@4.0.3             |
| py-pip@21.1.2            | parallel-netcdf@1.12.2     | parallel-netcdf@1.12.2     | parallel-netcdf@1.12.2     | parallel-netcdf@1.12.2     |
| py-virtualenv@16.7.6     | ior@3.3.0                  | ior@3.3.0                  | ior@3.3.0                  | ior@3.3.0                  |
| py-cython@0.29.24        | netcdf-c@4.8.1             | netcdf-c@4.8.1             | netcdf-c@4.8.1             | netcdf-c@4.8.1             |
| gdb@11.1                 | netcdf-cxx4@4.3.1          | netcdf-cxx4@4.3.1          | netcdf-cxx4@4.3.1          | netcdf-cxx4@4.3.1          |
| ninja@1.10.2             | netcdf-fortran@4.5.3       | netcdf-fortran@4.5.3       | netcdf-fortran@4.5.3       | netcdf-fortran@4.5.3       |
| meson@0.60.0             | py-mpi4py@3.1.2            | py-mpi4py@3.1.2            | py-mpi4py@3.1.2            | py-mpi4py@3.1.2            |
| openjdk@11.0.12\_7       | py-h5py@3.4.0              | py-h5py@3.4.0              | py-h5py@3.4.0              | py-h5py@3.4.0              |
| openjdk@1.8.0\_265-b01   | py-netcdf4@1.5.3           | py-netcdf4@1.5.3           | py-netcdf4@1.5.3           | py-netcdf4@1.5.3           |
| ant@1.10.7               | arpack-ng@3.7.0            | arpack-ng@3.7.0            | arpack-ng@3.7.0            | arpack-ng@3.7.0            |
| ffmpeg@4.3.2             | boost@1.77.0               | boost@1.77.0               | boost@1.77.0               | boost@1.77.0               |
| imagemagick@7.0.8-7      | superlu-dist@7.1.1         | superlu-dist@7.1.1         | superlu-dist@7.1.1         | superlu-dist@7.1.1         |
| gnuplot@5.4.2            | hypre@2.23.0               | hypre@2.23.0               | hypre@2.23.0               | hypre@2.23.0               |
| eigen@3.4.0              | valgrind@3.17.0            | valgrind@3.17.0            | valgrind@3.17.0            | valgrind@3.17.0            |
| openblas@0.3.18          | mpip@3.5                   | mpip@3.5                   | mpip@3.5                   | mpip@3.5                   |
| openblas@0.3.18-omp      | tau@2.30.2                 | tau@2.30.2                 | tau@2.30.2                 | tau@2.30.2                 |
| netlib-lapack@3.9.1      | scotch@6.1.1               | sprng@5.0                  |                            |                            |
| intel-mkl@2020.4.304     | mumps@5.4.0                |                            |                            | qchem@6.0                  |
| gsl@2.7                  | adios2@2.7.1               |
| fftw@3.3.10              | petsc@3.16.1               |
| fftw@2.1.5               | petsc@3.16.1-cmplx         |
| hdf5@1.10.7              | slepc@3.16.0               |
| metis@5.1.0              | slepc@3.16.0-cmplx         |
| netcdf-c@4.8.1           | py-petsc4py@3.16.1         |
| netcdf-cxx4@4.3.1        | py-slepc4py@3.16.0         |
| netcdf-fortran@4.5.3     | mrbayes@3.2.7a             |
| ncview@2.1.8             | raxml@8.2.12               | 
| nco@5.0.1                | relion@3.1.4               |
| glpk@4.65                | relion@4.0.0               | 
| qhull@2020.2             | plumed@2.6.3               |
| qrupdate@1.1.2           | gromacs@2020.4             |
| geos@3.9.1               | charmpp@6.10.2             | 
| py-numpy@1.20.3          | namd@2.14                  |
| py-scipy@1.5.4           | lammps@20210310            |
| py-sympy@1.8             | nwchem@7.0.2               |
| py-pandas@1.3.4          | siesta@4.0.2               | 
| py-h5py@3.4.0            | quantum-espresso@7.0       |
| py-netcdf4@1.5.3         | paraview@5.9.1             | 
| py-scikit-learn@1.0.1    | openfoam@2106              | 
| py-matplotlib@3.4.3      | wrf@4.2                    | 
| py-scikit-optimize@0.5.2 | wps@4.2                    |
| py-statsmodels@0.12.2    | neuron@8.0.0               |
| py-seaborn@0.11.2        |                            |
| py-dask@2021.6.2         | amber@22                   |
| py-jupyterlab@3.2.1      | vasp6@6.2.1                |
| arpack-ng@3.8.0          |
| boost@1.77.0             |
| adol-c@2.7.2             |
| hypre@2.23.0             |
| suite-sparse@5.10.1      | 
| superlu@5.3.0            |
| sprng@5.0                |
| libmatheval@1.1.11       |
| papi@6.0.0.1             |
| valgrind@3.17.0          |
| petsc@3.16.1             |
| petsc@3.16.1-cmplx       |
| slepc@3.16.0             |
| slepc@3.16.0-cmplx       |  
| py-petsc4py@3.16.1       |
| py-slepc4py@3.16.0       |
| r@4.1.1                  |
| julia@1.6.3              |
| octave@6.3.0             |
| esmf@8.1.1               |
| gdal@3.3.3               |
| adios2@2.7.1             |
| kokkos@3.4.01            |
| cgal@5.0.3               |
| cgal@4.13                |
| libxc@5.1.5              |
| molden@6.7               |
| vmd@1.9.3                |
| py-ase@3.21.1            |
| py-pyscf@1.7.5           |
| libbeagle@3.1.2          |
| beast1@1.8.4             |
| beast1@1.10.4            |
| beast2@2.5.2             |
| beast2@2.6.4             | 
| htslib@1.13              |
| htslib@1.12              |
| bcftools@1.12            |
| samtools@1.13            |
| bedtools2@2.30.0         |
| blast-plus@2.12.0        |
| fastp@0.20.0             |
| gatk@4.2.2.0             |
| kallisto@0.46.2          |
| picard@2.26.2            | 
| raxml-ng@1.0.2           |
| spades@3.15.3            |
| star@2.7.10a             |
| stringtie@1.3.4d         |
| trimmomatic@0.39         | 
| bowtie2@2.4.2            |
| bismark@0.23.0           |
| jellyfish@2.2.7          |
| salmon@1.4.0             |
| iq-tree@2.1.3            |
| trinity@2.12.0           |
| hisat2@2.2.0             |
| perl-bioperl@1.7.6       |
| py-pysam@0.15.3          |
| py-htseq@0.11.2          |



| intel@19.1.3.304         | openmpi@4.1.3              | intel-mpi@2019.10.317      | mvapich2@2.3.7             |
| ------------------------ | -------------------------- | -------------------------- | -------------------------- |
| cmake@3.21.4             | hpl@2.3                    | hpl@2.3                    | hpl@2.3                    |
| eigen@3.4.0              | hpl@2.3-omp                | hpl@2.3-omp                | hpl@2.3-omp                |
| openblas@0.3.18          | osu-micro-benchmarks@5.7.1 | osu-micro-benchmarks@5.7.1 | osu-micro-benchmarks@5.7.1 |
| openblas@0.3.18-omp      | netlib-scalapack@2.1.0     | netlib-scalapack@2.1.0     | netlib-scalapack@2.1.0     |
| netlib-lapack@3.9.1      | fftw@3.3.10                | fftw@3.3.10                | fftw@3.3.10                |
| intel-mkl@2020.4.304     | hdf5@1.10.7                | hdf5@1.10.7                | hdf5@1.10.7                |
| gsl@2.7                  | parmetis@4.0.3             | parmetis@4.0.3             | parmetis@4.0.3             |
| fftw@3.3.10              | parallel-netcdf@1.12.2     | parallel-netcdf@1.12.2     | parallel-netcdf@1.12.2     |
| hdf5@1.10.7              | ior@3.3.0                  | ior@3.3.0                  | ior@3.3.0                  |
| metis@5.1.0              | netcdf-c@4.8.1             | netcdf-c@4.8.1             | netcdf-c@4.8.1             |
| netcdf-c@4.8.1           | netcdf-cxx4@4.3.1          | netcdf-cxx4@4.3.1          | netcdf-cxx4@4.3.1          | 
| netcdf-cxx4@4.3.1        | netcdf-fortran@4.5.3       | netcdf-fortran@4.5.3       | netcdf-fortran@4.5.3       |
| netcdf-fortran@4.5.3     | arpack-ng@3.7.0            | arpack-ng@3.7.0            | arpack-ng@3.7.0            |
| arpack-ng@3.8.0          | superlu-dist@7.1.1         | superlu-dist@7.1.1         | superlu-dist@7.1.1         |
| hypre@2.23.0             | hypre@2.23.0               | hypre@2.23.0               | hypre@2.23.0               |
| suite-sparse@5.10.1      | valgrind@3.17.0            | valgrind@3.17.0            | valgrind@3.17.0            |
| superlu@5.3.0            | mpip@3.5                   | mpip@3.5                   | mpip@3.5                   |
| sprng@5.0                | tau@2.30.2                 | tau@2.30.2                 | tau@2.30.2                 |
| papi@6.0.0.1             |
| valgrind@3.17.0          |
| petsc@3.16.1             |
| petsc@3.16.1-cmplx       |
| slepc@3.16.0             |
| slepc@3.16.0-cmplx       |



| aocc@3.2.0               | openmpi@4.1.3              |
| ------------------------ | -------------------------- |
| cmake@3.21.4             | hpl@2.3                    |
| amdlibm@3.1              | hpl@2.3-omp                |
| eigen@3.4.0              | osu-micro-benchmarks@5.7.1 |
| openblas@0.3.18          | netlib-scalapack@2.1.0     |
| amdblis@3.1              | amdscalapack@3.1           |
| amdblis@3.1-omp          | fftw@3.3.10                |
| netlib-lapack@3.9.1      | amdfftw@3.1                |
| amdlibflame@3.1          | hdf5@1.10.7                |
| gsl@2.7                  | parmetis@4.0.3             |
| fftw@3.3.10              | parallel-netcdf@1.12.2     |
| amdfftw@3.1              | ior@3.3.0                  |
| amdfftw@3.1-omp          |                            |
| hdf5@1.10.7              | netcdf-c@4.8.1             |
| metis@5.1.0              | netcdf-cxx4@4.3.1          |
| netcdf-c@4.8.1           | netcdf-fortran@4.5.3       |
| netcdf-cxx4@4.3.1        | boost@1.77.0               | 
| netcdf-fortran@4.5.3     | superlu-dist@7.1.1         |
| boost@1.77.0             | hypre@2.23.0               |
| aocl-sparse@3.1          | valgrind@3.17.0            |
| hypre@2.23.0             | mpip@3.5                   |
| suite-sparse@5.10.1      | scotch@6.1.1               |
| superlu@5.3.0            | adios2@2.7.1               |
| sprng@5.0                | petsc@3.16.1               |
| papi@6.0.0.1             |                            |
| valgrind@3.17.0          | gromacs@2020.4             |
| cgal@5.0.3               | charmpp@6.10.2             |
| cgal@4.13                | namd@2.14                  |
|                          | lammps@20210310            |
|                          | nwchem@7.0.2               |
|                          | cp2k@7.1                   |
|                          | openfoam@2106              |
|                          | wrf@4.2                    |
|                          | wps@4.2                    |
|                          |                            |
|                          | vasp6@6.2.1                |
[mkandes@login02 dev]$
[mkandes@login02 dev]$ vi SPECS.md 
[mkandes@login02 dev]$ cat SPECS.md 
# expanse/0.17.3/cpu


| Core (gcc@8.5.0)           |
| -------------------------- |



| gcc@10.2.0               | openmpi@4.1.3              | mvapich2@2.3.7             |     
| ------------------------ | -------------------------- | -------------------------- |
|                          | hpl@2.3                    | hpl@2.3                    |
|                          | hpl@2.3-omp                | hpl@2.3-omp                |
|                          | osu-micro-benchmarks@5.7.1 | osu-micro-benchmarks@5.7.1 |
|                          | ior@3.3.0                  | ior@3.3.0                  |
|                          | gromacs@2020.4             |
|                          | namd@2.14                  |
|                          | quantum-espresso@7.0       |
|                          | openfoam@2106              | 
|                          | wrf@4.2                    | 
|                          | neuron@8.0.0               |
| beast2@2.6.4             |                            |


| aocc@3.2.0               | openmpi@4.1.3              |
| ------------------------ | -------------------------- |
|                          | hpl@2.3                    |
|                          | hpl@2.3-omp                |
|                          | osu-micro-benchmarks@5.7.1 |
|                          | ior@3.3.0                  |
|                          | gromacs@2020.4             |
|                          | namd@2.14                  |
|                          | openfoam@2106              |
|                          | wrf@4.2                    |
[mkandes@login02 dev]$
```

This should get us started. We'll have to fill in the key explicit dependencies for the benchmark applications as we build out the instance, but that will be a good to review as well working back from spack info and spack find for applications as currently deployed in production. Let's go ahead and create the initial spec build scripts starting from the existing production ones. 

```
[mkandes@login02 dev]$ ls
SPECS.md  yamls
[mkandes@login02 dev]$ mkdir specs
[mkandes@login02 dev]$ cd specs/
[mkandes@login02 specs]$ cp -rp ../../
b/   dev/ 
[mkandes@login02 specs]$ cp -rp ../../b/
specs/    SPECS.md  yamls/    
[mkandes@login02 specs]$ cp -rp ../../b/specs/
anaconda3@2021.05.o21694095.exp-15-56           git@2.31.1.o21693612.exp-15-56                  parallel@20210922.sh
anaconda3@2021.05.sh                            git@2.31.1.sh                                   pgi@18.10/
aocc@3.2.0/                                     git-lfs@2.11.0.o21693736.exp-15-56              pgi@18.10.sh
aocc@3.2.0.o21740680.exp-15-56                  git-lfs@2.11.0.sh                               pigz@2.6.o21693610.exp-15-56
aocc@3.2.0.o21740726.exp-15-56                  intel@19.1.3.304/                               pigz@2.6.sh
aocc@3.2.0.sh                                   intel@19.1.3.304.o21749258.exp-15-56            rclone@1.56.2.o21694048.exp-15-56
aria2@1.35.0.o21694011.exp-15-56                intel@19.1.3.304.o21749373.exp-15-56            rclone@1.56.2.sh
aria2@1.35.0.sh                                 intel@19.1.3.304.sh                             sratoolkit@2.10.9.o21694059.exp-15-56
entrezdirect@10.7.20190114.o21694065.exp-15-56  libxsmm@1.16.3.sh                               sratoolkit@2.10.9.sh
entrezdirect@10.7.20190114.sh                   matlab@2022b.sh                                 subversion@1.14.0.o21693810.exp-15-56
gcc@10.2.0/                                     mercurial@5.8.o21693989.exp-15-56               subversion@1.14.0.sh
gcc@10.2.0.o21694812.exp-15-56                  mercurial@5.8.sh                                ucx@1.10.1.o21745904.exp-15-56
gcc@10.2.0.sh                                   nvhpc@21.3/                                     ucx@1.10.1.sh
gh@2.0.0.o21693793.exp-15-56                    nvhpc@21.3.sh                                   
gh@2.0.0.sh                                     parallel@20210922.o21693459.exp-15-56           
[mkandes@login02 specs]$ cp -rp ../../b/specs/
anaconda3@2021.05.o21694095.exp-15-56           git@2.31.1.o21693612.exp-15-56                  parallel@20210922.sh
anaconda3@2021.05.sh                            git@2.31.1.sh                                   pgi@18.10/
aocc@3.2.0/                                     git-lfs@2.11.0.o21693736.exp-15-56              pgi@18.10.sh
aocc@3.2.0.o21740680.exp-15-56                  git-lfs@2.11.0.sh                               pigz@2.6.o21693610.exp-15-56
aocc@3.2.0.o21740726.exp-15-56                  intel@19.1.3.304/                               pigz@2.6.sh
aocc@3.2.0.sh                                   intel@19.1.3.304.o21749258.exp-15-56            rclone@1.56.2.o21694048.exp-15-56
aria2@1.35.0.o21694011.exp-15-56                intel@19.1.3.304.o21749373.exp-15-56            rclone@1.56.2.sh
aria2@1.35.0.sh                                 intel@19.1.3.304.sh                             sratoolkit@2.10.9.o21694059.exp-15-56
entrezdirect@10.7.20190114.o21694065.exp-15-56  libxsmm@1.16.3.sh                               sratoolkit@2.10.9.sh
entrezdirect@10.7.20190114.sh                   matlab@2022b.sh                                 subversion@1.14.0.o21693810.exp-15-56
gcc@10.2.0/                                     mercurial@5.8.o21693989.exp-15-56               subversion@1.14.0.sh
gcc@10.2.0.o21694812.exp-15-56                  mercurial@5.8.sh                                ucx@1.10.1.o21745904.exp-15-56
gcc@10.2.0.sh                                   nvhpc@21.3/                                     ucx@1.10.1.sh
gh@2.0.0.o21693793.exp-15-56                    nvhpc@21.3.sh                                   
gh@2.0.0.sh                                     parallel@20210922.o21693459.exp-15-56           
[mkandes@login02 specs]$ cp -p ../../b/specs/gcc@10.2.0.sh ./
[mkandes@login02 specs]$ cp -p ../../b/specs/aocc@3.2.0.sh ./
[mkandes@login02 specs]$ mkdir gcc@10.2.0
[mkandes@login02 specs]$ mkdir aocc@3.2.0
[mkandes@login02 specs]$ cd gcc@10.2.0/
[mkandes@login02 gcc@10.2.0]$ cp -p ../../../b/specs/gcc@10.2.0/beast2@2.6.4.sh ./
[mkandes@login02 gcc@10.2.0]$ cp -p ../../../b/specs/gcc@10.2.0/openmpi@4.1.3.sh ./
[mkandes@login02 gcc@10.2.0]$ cp -p ../../../b/specs/gcc@10.2.0/mvapich2@2.3.7.sh ./
[mkandes@login02 gcc@10.2.0]$ mkdir openmpi@4.1.3
[mkandes@login02 gcc@10.2.0]$ mkdir mvapich2@2.3.7
[mkandes@login02 gcc@10.2.0]$ cd openmpi@4.1.3/
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/hpl@2.3.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/hpl@2.3-omp.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/osu-micro-benchmarks@5.7.1.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/ior@3.3.0.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/gromacs@202
gromacs@2020.4.o21717638.exp-15-56  gromacs@2020.4.sh                   gromacs@2022.6.o25387651.exp-15-56  gromacs@2022.6.sh
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/gromacs@2020.4.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/gromacs@2022.6.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/namd@2.14.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/quantum-espresso@
quantum-espresso@6.4.1.sh                 quantum-espresso@7.0.o21719337.exp-15-56  quantum-espresso@7.0.sh
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/quantum-espresso@7.0.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/openfoam@2106.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/wrf@4.2.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp -p ../../../../b/specs/gcc@10.2.0/openmpi@4.1.3/neuron@8.0.0.sh ./
[mkandes@login02 openmpi@4.1.3]$ cd ../mvapich2@2.3.7/
[mkandes@login02 mvapich2@2.3.7]$ cp -p ../../../../b/specs/gcc@10.2.0/mvapich2@2.3.7/hpl@2.3.sh ./
[mkandes@login02 mvapich2@2.3.7]$ cp -p ../../../../b/specs/gcc@10.2.0/mvapich2@2.3.7/hpl@2.3-omp.sh ./
[mkandes@login02 mvapich2@2.3.7]$ cp -p ../../../../b/specs/gcc@10.2.0/mvapich2@2.3.7/osu-micro-benchmarks@5.7.1.sh ./
[mkandes@login02 mvapich2@2.3.7]$ cp -p ../../../../b/specs/gcc@10.2.0/mvapich2@2.3.7/ior@3.3.0.sh ./
[mkandes@login02 mvapich2@2.3.7]$ cd ../
[mkandes@login02 gcc@10.2.0]$ cd ../aocc@3.2.0/
[mkandes@login02 aocc@3.2.0]$ cp ../../../b/specs/aocc@3.2.0/openmpi@4.1.3.sh ./
[mkandes@login02 aocc@3.2.0]$ mkdir openmpi@4.1.3
[mkandes@login02 aocc@3.2.0]$ cd openmpi@4.1.3/
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/hpl@2.3.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/hpl@2.3-omp.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/osu-micro-benchmarks@5.7.1.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/ior@3.3.0.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/gromacs@2020.4.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/namd@2.14.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/openfoam@2106.sh ./
[mkandes@login02 openmpi@4.1.3]$ cp ../../../../b/specs/aocc@3.2.0/openmpi@4.1.3/wrf@4.2.sh ./
[mkandes@login02 openmpi@4.1.3]$ cd ../
[mkandes@login02 aocc@3.2.0]$ cd ../
[mkandes@login02 specs]$ cd ../
[mkandes@login02 dev]$ ls
specs  SPECS.md  yamls
[mkandes@login02 dev]$
```

We're now ready to start the initial build out of the instance ...

```
[mkandes@login02 spack]$ pwd
/home/mkandes/software/spack/repositories/mkandes/spack/etc/spack
[mkandes@login02 spack]$ cp -rp sdsc/expanse/0.17.3/cpu/dev/yamls/*.yaml ./
[mkandes@login02 spack]$ ls
compilers.yaml  defaults  modules.yaml  packages.yaml  repos.yaml  sdsc
[mkandes@login02 spack]$
[mkandes@login02 specs]$ pwd
/home/mkandes/software/spack/repositories/mkandes/spack/etc/spack/sdsc/expanse/0.17.3/cpu/dev/specs
[mkandes@login02 specs]$ sbatch gcc@10.2.0.sh 
Submitted batch job 30010131 on cluster expanse
[mkandes@login02 specs]$ squeue -u $USER
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
          30010131 ind-share gcc@10.2  mkandes PD       0:00      1 (Priority)
[mkandes@login02 specs]$ squeue -u $USER
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
          30010131 ind-share gcc@10.2  mkandes  R       1:51      1 exp-15-40
[mkandes@login02 specs]$ cat gcc@10.2.0.o30010131.exp-15-40 
1713556956 20240419T130236-0700 30010131 2340624b71929ba23f6bb2f95a3858a5 145a2e2a99931f7b88a0d991a4beead2b900900c24c7f10b8107aaf89a844952 77 /home/mkandes/software/spack/repositories/mkandes/spack/etc/spack/sdsc/expanse/0.17.3/cpu/dev/specs/gcc@10.2.0.sh
#!/usr/bin/env bash

#SBATCH --job-name=gcc@10.2.0
#SBATCH --account=use300
#SBATCH --clusters=expanse
#SBATCH --partition=ind-shared
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=32G
#SBATCH --time=01:00:00
#SBATCH --output=%x.o%j.%N

declare -xir UNIX_TIME="$(date +'%s')"
declare -xr LOCAL_TIME="$(date +'%Y%m%dT%H%M%S%z')"

declare -xr LOCAL_SCRATCH="/scratch/${USER}/job_${SLURM_JOB_ID}"
declare -xr TMPDIR="${LOCAL_SCRATCH_DIR}"

declare -xr JOB_SCRIPT="$(scontrol show job ${SLURM_JOB_ID} | awk -F= '/Command=/{print $2}')"
declare -xr JOB_SCRIPT_MD5="$(md5sum ${JOB_SCRIPT} | awk '{print $1}')"
declare -xr JOB_SCRIPT_SHA256="$(sha256sum ${JOB_SCRIPT} | awk '{print $1}')"
declare -xr JOB_SCRIPT_NUMBER_OF_LINES="$(wc -l ${JOB_SCRIPT} | awk '{print $1}')"

declare -xr SCHEDULER_NAME='slurm'
declare -xr SCHEDULER_MAJOR='23'
declare -xr SCHEDULER_MINOR='02'
declare -xr SCHEDULER_REVISION='7'
declare -xr SCHEDULER_VERSION="${SCHEDULER_MAJOR}.${SCHEDULER_MINOR}.${SCHEDULER_REVISION}"
declare -xr SCHEDULER_MODULE="${SCHEDULER_NAME}/${SLURM_CLUSTER_NAME}/${SCHEDULER_VERSION}"

declare -xr SPACK_MAJOR='0'
declare -xr SPACK_MINOR='17'
declare -xr SPACK_REVISION='3'
declare -xr SPACK_VERSION="${SPACK_MAJOR}.${SPACK_MINOR}.${SPACK_REVISION}"
declare -xr SPACK_INSTANCE_NAME='cpu'
declare -xr SPACK_INSTANCE_VERSION='dev'
declare -xr SPACK_INSTANCE_DIR='/home/mkandes/software/spack/repositories/mkandes/spack'

declare -xr SPACK_PACKAGE='gcc@10.2.0'
declare -xr SPACK_COMPILER='gcc@8.5.0'
declare -xr SPACK_VARIANTS='~binutils ~bootstrap ~graphite ~nvptx ~piclibs ~strip'
declare -xr SPACK_DEPENDENCIES=''
declare -xr SPACK_SPEC="${SPACK_PACKAGE} % ${SPACK_COMPILER} ${SPACK_VARIANTS} ${SPACK_DEPENDENCIES}"

echo "${UNIX_TIME} ${LOCAL_TIME} ${SLURM_JOB_ID} ${JOB_SCRIPT_MD5} ${JOB_SCRIPT_SHA256} ${JOB_SCRIPT_NUMBER_OF_LINES} ${JOB_SCRIPT}"
cat  "${JOB_SCRIPT}"

module purge
module load "${SCHEDULER_MODULE}"
module list
. "${SPACK_INSTANCE_DIR}/share/spack/setup-env.sh"
printenv

spack config get compilers  
spack config get config  
spack config get mirrors
spack config get modules
spack config get packages
spack config get repos
spack config get upstreams

time -p spack spec --long --namespaces --types "${SPACK_SPEC}"
if [[ "${?}" -ne 0 ]]; then
  echo 'ERROR: spack concretization failed.'
  exit 1
fi

time -p spack install --jobs "${SLURM_CPUS_PER_TASK}" --fail-fast --yes-to-all "${SPACK_SPEC}"
if [[ "${?}" -ne 0 ]]; then
  echo 'ERROR: spack install failed.'
  exit 1
fi

spack compiler add --scope site "$(spack location -i ${SPACK_PACKAGE})"

sleep 30

Currently Loaded Modules:
  1) slurm/expanse/23.02.7

 

CONDA_SHLVL=0
LD_LIBRARY_PATH=/cm/shared/apps/slurm/current/lib64/slurm:/cm/shared/apps/slurm/current/lib64
LS_COLORS=rs=0:di=38;5;33:ln=38;5;51:mh=00:pi=40;38;5;11:so=38;5;13:do=38;5;5:bd=48;5;232;38;5;11:cd=48;5;232;38;5;3:or=48;5;232;38;5;9:mi=01;05;37;41:su=48;5;196;38;5;15:sg=48;5;11;38;5;16:ca=48;5;196;38;5;226:tw=48;5;10;38;5;16:ow=48;5;10;38;5;21:st=48;5;21;38;5;15:ex=38;5;40:*.tar=38;5;9:*.tgz=38;5;9:*.arc=38;5;9:*.arj=38;5;9:*.taz=38;5;9:*.lha=38;5;9:*.lz4=38;5;9:*.lzh=38;5;9:*.lzma=38;5;9:*.tlz=38;5;9:*.txz=38;5;9:*.tzo=38;5;9:*.t7z=38;5;9:*.zip=38;5;9:*.z=38;5;9:*.dz=38;5;9:*.gz=38;5;9:*.lrz=38;5;9:*.lz=38;5;9:*.lzo=38;5;9:*.xz=38;5;9:*.zst=38;5;9:*.tzst=38;5;9:*.bz2=38;5;9:*.bz=38;5;9:*.tbz=38;5;9:*.tbz2=38;5;9:*.tz=38;5;9:*.deb=38;5;9:*.rpm=38;5;9:*.jar=38;5;9:*.war=38;5;9:*.ear=38;5;9:*.sar=38;5;9:*.rar=38;5;9:*.alz=38;5;9:*.ace=38;5;9:*.zoo=38;5;9:*.cpio=38;5;9:*.7z=38;5;9:*.rz=38;5;9:*.cab=38;5;9:*.wim=38;5;9:*.swm=38;5;9:*.dwm=38;5;9:*.esd=38;5;9:*.jpg=38;5;13:*.jpeg=38;5;13:*.mjpg=38;5;13:*.mjpeg=38;5;13:*.gif=38;5;13:*.bmp=38;5;13:*.pbm=38;5;13:*.pgm=38;5;13:*.ppm=38;5;13:*.tga=38;5;13:*.xbm=38;5;13:*.xpm=38;5;13:*.tif=38;5;13:*.tiff=38;5;13:*.png=38;5;13:*.svg=38;5;13:*.svgz=38;5;13:*.mng=38;5;13:*.pcx=38;5;13:*.mov=38;5;13:*.mpg=38;5;13:*.mpeg=38;5;13:*.m2v=38;5;13:*.mkv=38;5;13:*.webm=38;5;13:*.ogm=38;5;13:*.mp4=38;5;13:*.m4v=38;5;13:*.mp4v=38;5;13:*.vob=38;5;13:*.qt=38;5;13:*.nuv=38;5;13:*.wmv=38;5;13:*.asf=38;5;13:*.rm=38;5;13:*.rmvb=38;5;13:*.flc=38;5;13:*.avi=38;5;13:*.fli=38;5;13:*.flv=38;5;13:*.gl=38;5;13:*.dl=38;5;13:*.xcf=38;5;13:*.xwd=38;5;13:*.yuv=38;5;13:*.cgm=38;5;13:*.emf=38;5;13:*.ogv=38;5;13:*.ogx=38;5;13:*.aac=38;5;45:*.au=38;5;45:*.flac=38;5;45:*.m4a=38;5;45:*.mid=38;5;45:*.midi=38;5;45:*.mka=38;5;45:*.mp3=38;5;45:*.mpc=38;5;45:*.ogg=38;5;45:*.ra=38;5;45:*.wav=38;5;45:*.oga=38;5;45:*.opus=38;5;45:*.spx=38;5;45:*.xspf=38;5;45:
CONDA_EXE=/home/mkandes/software/miniconda/Miniconda3-py312_24.1.2-0-Linux-x86_64/bin/conda
SLURM_NODEID=0
SLURM_TASK_PID=2249714
__LMOD_REF_COUNT_PATH=/cm/shared/apps/slurm/current/sbin:1;/cm/shared/apps/slurm/current/bin:1;/home/mkandes/software/miniconda/Miniconda3-py312_24.1.2-0-Linux-x86_64/condabin:1;/home/mkandes/.local/bin:1;/home/mkandes/bin:1;/usr/local/bin:1;/usr/bin:1;/usr/local/sbin:1;/usr/sbin:1
_ModuleTable002_=L2V0Yy9tb2R1bGVmaWxlcyIsIi91c3Ivc2hhcmUvbW9kdWxlZmlsZXMiLCIvdXNyL3NoYXJlL01vZHVsZXMvbW9kdWxlZmlsZXMiLCIvY20vc2hhcmVkL21vZHVsZWZpbGVzIix9LFsic3lzdGVtQmFzZU1QQVRIIl09Ii9jbS9sb2NhbC9tb2R1bGVmaWxlczovY20vc2hhcmVkL2FwcHMvYWNjZXNzL21vZHVsZWZpbGVzOi9jbS9zaGFyZWQvbW9kdWxlZmlsZXM6L2V0Yy9tb2R1bGVmaWxlczovdXNyL3NoYXJlL21vZHVsZWZpbGVzOi91c3Ivc2hhcmUvTW9kdWxlcy9tb2R1bGVmaWxlcyIsfQ==
SSH_CONNECTION=208.58.212.11 39928 198.202.100.14 22
SPACK_PYTHON=/usr/bin/python3
SPACK_MAJOR=0
SLURM_PRIO_PROCESS=0
LANG=en_US.UTF-8
SLURM_SUBMIT_DIR=/home/mkandes/software/spack/repositories/mkandes/spack/etc/spack/sdsc/expanse/0.17.3/cpu/dev/specs
HISTCONTROL=ignoredups
SCHEDULER_NAME=slurm
HOSTNAME=exp-15-40
LMOD_SYSTEM_DEFAULT_MODULES=DefaultModules
OLDPWD=/home/mkandes/software/spack/repositories/mkandes/spack/etc/spack/sdsc/expanse/0.17.3/cpu/dev
__LMOD_REF_COUNT__LMFILES_=/cm/shared/modulefiles/slurm/expanse/23.02.7:1
SLURM_CPUS_PER_TASK=16
SPACK_DEPENDENCIES=
SCHEDULER_MINOR=02
ENVIRONMENT=BATCH
SPACK_VERSION=0.17.3
SPACK_MINOR=17
SLURM_PROCID=0
SPACK_INSTANCE_VERSION=dev
SLURM_JOB_GID=300
SPACK_VARIANTS=~binutils ~bootstrap ~graphite ~nvptx ~piclibs ~strip
SCHEDULER_REVISION=7
SPACK_INSTANCE_DIR=/home/mkandes/software/spack/repositories/mkandes/spack
__LMOD_REF_COUNT_LD_LIBRARY_PATH=/cm/shared/apps/slurm/current/lib64/slurm:1;/cm/shared/apps/slurm/current/lib64:1
SCHEDULER_VERSION=23.02.7
SLURMD_NODENAME=exp-15-40
SLURM_JOB_END_TIME=1713560554
JOB_SCRIPT_MD5=2340624b71929ba23f6bb2f95a3858a5
SLURM_TASKS_PER_NODE=1
S_COLORS=auto
_CE_M=
which_declare=declare -f
SPACK_COMPILER=gcc@8.5.0
XDG_SESSION_ID=551970
SLURM_NNODES=1
USER=mkandes
SLURM_PMIX_TMPDIR=/scratch/mkandes/job_30010131
SLURM_TMPDIR=/scratch/mkandes/job_30010131
JOB_SCRIPT_NUMBER_OF_LINES=77
SLURM_JOB_START_TIME=1713556954
SLURM_NTASKS_PER_NODE=1
__LMOD_REF_COUNT_MODULEPATH=/cm/local/modulefiles:1;/cm/shared/apps/access/modulefiles:1;/etc/modulefiles:1;/usr/share/modulefiles:1;/usr/share/Modules/modulefiles:1;/cm/shared/modulefiles:1
__LMOD_REF_COUNT_LOADEDMODULES=slurm/expanse/23.02.7:1
SCHEDULER_MAJOR=23
PWD=/home/mkandes/software/spack/repositories/mkandes/spack/etc/spack/sdsc/expanse/0.17.3/cpu/dev/specs
ENABLE_LMOD=1
SLURM_JOB_NODELIST=exp-15-40
HOME=/home/mkandes
SLURM_CLUSTER_NAME=expanse
CONDA_PYTHON_EXE=/home/mkandes/software/miniconda/Miniconda3-py312_24.1.2-0-Linux-x86_64/bin/python
LMOD_COLORIZE=yes
LOCAL_TIME=20240419T130236-0700
SLURM_NODELIST=exp-15-40
LMOD_SYSHOST=expanse
SSH_CLIENT=208.58.212.11 39928 22
LMOD_VERSION=8.2.4
CPATH=/cm/shared/apps/slurm/current/include
SLURM_NTASKS=1
LMOD_SETTARG_CMD=:
SLURM_JOB_CPUS_PER_NODE=16
BASH_ENV=/usr/share/lmod/lmod/init/bash
SLURM_TOPOLOGY_ADDR=exp-15-40
_CE_CONDA=
SLURM_WORKING_CLUSTER=expanse:mgr1:6817:9984:109
JOB_SCRIPT_SHA256=145a2e2a99931f7b88a0d991a4beead2b900900c24c7f10b8107aaf89a844952
SPACK_PACKAGE=gcc@10.2.0
__LMOD_REF_COUNT_LIBRARY_PATH=/cm/shared/apps/slurm/current/lib64/slurm:1;/cm/shared/apps/slurm/current/lib64:1
SLURM_JOB_NAME=gcc@10.2.0
TMPDIR=
LIBRARY_PATH=/cm/shared/apps/slurm/current/lib64/slurm:/cm/shared/apps/slurm/current/lib64
LMOD_sys=Linux
SLURM_JOBID=30010131
_ModuleTable001_=X01vZHVsZVRhYmxlXz17WyJNVHZlcnNpb24iXT0zLFsiY19yZWJ1aWxkVGltZSJdPWZhbHNlLFsiY19zaG9ydFRpbWUiXT1mYWxzZSxkZXB0aFQ9e30sZmFtaWx5PXt9LG1UPXtbInNsdXJtL2V4cGFuc2UiXT17WyJmbiJdPSIvY20vc2hhcmVkL21vZHVsZWZpbGVzL3NsdXJtL2V4cGFuc2UvMjMuMDIuNyIsWyJmdWxsTmFtZSJdPSJzbHVybS9leHBhbnNlLzIzLjAyLjciLFsibG9hZE9yZGVyIl09MSxwcm9wVD17fSxbInN0YWNrRGVwdGgiXT0wLFsic3RhdHVzIl09ImFjdGl2ZSIsWyJ1c2VyTmFtZSJdPSJzbHVybS9leHBhbnNlLzIzLjAyLjciLH0sfSxtcGF0aEE9eyIvY20vbG9jYWwvbW9kdWxlZmlsZXMiLCIvY20vc2hhcmVkL2FwcHMvYWNjZXNzL21vZHVsZWZpbGVzIiwi
SLURM_CONF=/cm/shared/apps/slurm/var/etc/expanse/slurm.conf
LOADEDMODULES=slurm/expanse/23.02.7
__LMOD_REF_COUNT_MANPATH=/cm/shared/apps/slurm/current/man:2;/usr/share/lmod/lmod/share/man:1;/usr/local/share/man:1;/usr/share/man:1;/cm/local/apps/environment-modules/current/share/man:1
_ModuleTable003_=TmFtZSJdPSJzaGFyZWQiLH0sc2x1cm09e1siZm4iXT0iL2NtL2xvY2FsL21vZHVsZWZpbGVzL3NsdXJtL2V4cGFuc2UvMjMuMDIuNyIsWyJmdWxsTmFtZSJdPSJzbHVybS9leHBhbnNlLzIzLjAyLjciLFsibG9hZE9yZGVyIl09Myxwcm9wVD17fSxbInN0YWNrRGVwdGgiXT0yLFsic3RhdHVzIl09ImFjdGl2ZSIsWyJ1c2VyTmFtZSJdPSJzbHVybSIsfSx9LG1wYXRoQT17Ii9jbS9zaGFyZWQvYXBwcy9zcGFjay8wLjE3LjMvY3B1L2Ivc2hhcmUvc3BhY2svbG1vZC9saW51eC1yb2NreTgteDg2XzY0L0NvcmUiLCIvY20vbG9jYWwvbW9kdWxlZmlsZXMiLCIvY20vc2hhcmVkL2FwcHMvYWNjZXNzL21vZHVsZWZpbGVzIiwiL2V0Yy9tb2R1bGVmaWxlcyIsIi91c3Ivc2hhcmUvbW9k
SLURM_NODE_ALIASES=(null)
SLURM_JOB_QOS=ind-shared-normal
LMOD_ROOT=/usr/share/lmod
SLURM_TOPOLOGY_ADDR_PATTERN=node
SSH_TTY=/dev/pts/376
MAIL=/var/spool/mail/mkandes
SLURM_CPUS_ON_NODE=16
LMOD_arch=x86_64
SLURM_JOB_NUM_NODES=1
__Init_Default_Modules=1
CMD_WLM_CLUSTER_NAME=expanse
SLURM_MEM_PER_NODE=32768
SPACK_ROOT=/home/mkandes/software/spack/repositories/mkandes/spack
SHELL=/bin/bash
TERM=xterm-256color
SLURM_JOB_UID=501506
_ModuleTable_Sz_=2
__LMOD_REF_COUNT_CPATH=/cm/shared/apps/slurm/current/include:1
SLURM_JOB_PARTITION=ind-shared
SLURM_SCRIPT_CONTEXT=prolog_task
SPACK_INSTANCE_NAME=cpu
SLURM_JOB_USER=mkandes
JOB_SCRIPT=/home/mkandes/software/spack/repositories/mkandes/spack/etc/spack/sdsc/expanse/0.17.3/cpu/dev/specs/gcc@10.2.0.sh
SLURM_NPROCS=1
SHLVL=2
SLURM_SUBMIT_HOST=login02
UNIX_TIME=1713556956
SLURM_JOB_ACCOUNT=use300
MANPATH=/cm/shared/apps/slurm/current/man:/usr/share/lmod/lmod/share/man::/usr/local/share/man:/usr/share/man:/cm/local/apps/environment-modules/current/share/man
LMOD_PREPEND_BLOCK=normal
MODULEPATH=/cm/local/modulefiles:/cm/shared/apps/access/modulefiles:/etc/modulefiles:/usr/share/modulefiles:/usr/share/Modules/modulefiles:/cm/shared/modulefiles
SLURM_GTIDS=0
LOGNAME=mkandes
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/501506/bus
XDG_RUNTIME_DIR=/run/user/501506
MODULEPATH_ROOT=/usr/share/modulefiles
LMOD_PACKAGE_PATH=/usr/share/lmod/etc/site/lmod
PATH=/home/mkandes/software/spack/repositories/mkandes/spack/bin:/cm/shared/apps/slurm/current/sbin:/cm/shared/apps/slurm/current/bin:/home/mkandes/software/miniconda/Miniconda3-py312_24.1.2-0-Linux-x86_64/condabin:/home/mkandes/.local/bin:/home/mkandes/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
SLURM_JOB_ID=30010131
_LMFILES_=/cm/shared/modulefiles/slurm/expanse/23.02.7
SPACK_REVISION=3
DEBUGINFOD_URLS=https://debuginfod.centos.org/ 
SCHEDULER_MODULE=slurm/expanse/23.02.7
MODULESHOME=/usr/share/lmod/lmod
LMOD_SETTARG_FULL_SUPPORT=no
HISTSIZE=-1
LMOD_PKG=/usr/share/lmod/lmod
LOCAL_SCRATCH=/scratch/mkandes/job_30010131
SPACK_SPEC=gcc@10.2.0 % gcc@8.5.0 ~binutils ~bootstrap ~graphite ~nvptx ~piclibs ~strip 
LMOD_CMD=/usr/share/lmod/lmod/libexec/lmod
SLURM_LOCALID=0
LESSOPEN=||/usr/bin/lesspipe.sh %s
LMOD_FULL_SETTARG_SUPPORT=no
LMOD_DIR=/usr/share/lmod/lmod/libexec
BASH_FUNC_which%%=() {  ( alias;
 eval ${which_declare} ) | /usr/bin/which --tty-only --read-alias --read-functions --show-tilde --show-dot $@
}
BASH_FUNC_module%%=() {  eval $($LMOD_CMD bash "$@") && eval $(${LMOD_SETTARG_CMD:-:} -s sh)
}
BASH_FUNC_spack%%=() {  : this is a shell function from: /home/mkandes/software/spack/repositories/mkandes/spack/share/spack/setup-env.sh;
 : the real spack script is here: /home/mkandes/software/spack/repositories/mkandes/spack/bin/spack;
 _spack_shell_wrapper "$@";
 return $?
}
BASH_FUNC__spack_shell_wrapper%%=() {  for var in LD_LIBRARY_PATH DYLD_LIBRARY_PATH DYLD_FALLBACK_LIBRARY_PATH;
 do
 eval "if [ -n \"\${${var}-}\" ]; then export SPACK_$var=\${${var}}; fi";
 done;
 if [ -n "${ZSH_VERSION:-}" ]; then
 emulate -L sh;
 fi;
 _sp_flags="";
 while [ ! -z ${1+x} ] && [ "${1#-}" != "${1}" ]; do
 _sp_flags="$_sp_flags $1";
 shift;
 done;
 if [ -n "$_sp_flags" ] && [ "${_sp_flags#*h}" != "${_sp_flags}" ] || [ "${_sp_flags#*V}" != "${_sp_flags}" ]; then
 command spack $_sp_flags "$@";
 return;
 fi;
 _sp_subcommand="";
 if [ ! -z ${1+x} ]; then
 _sp_subcommand="$1";
 shift;
 fi;
 case $_sp_subcommand in 
 "cd")
 _sp_arg="";
 if [ -n "$1" ]; then
 _sp_arg="$1";
 shift;
 fi;
 if [ "$_sp_arg" = "-h" ] || [ "$_sp_arg" = "--help" ]; then
 command spack cd -h;
 else
 LOC="$(spack location $_sp_arg "$@")";
 if [ -d "$LOC" ]; then
 cd "$LOC";
 else
 return 1;
 fi;
 fi;
 return
 ;;
 "env")
 _sp_arg="";
 if [ -n "$1" ]; then
 _sp_arg="$1";
 shift;
 fi;
 if [ "$_sp_arg" = "-h" ] || [ "$_sp_arg" = "--help" ]; then
 command spack env -h;
 else
 case $_sp_arg in 
 activate)
 _a=" $@";
 if [ -z ${1+x} ] || [ "${_a#* --sh}" != "$_a" ] || [ "${_a#* --csh}" != "$_a" ] || [ "${_a#* -h}" != "$_a" ] || [ "${_a#* --help}" != "$_a" ]; then
 command spack env activate "$@";
 else
 stdout="$(command spack $_sp_flags env activate --sh "$@")" || return;
 eval "$stdout";
 fi
 ;;
 deactivate)
 _a=" $@";
 if [ "${_a#* --sh}" != "$_a" ] || [ "${_a#* --csh}" != "$_a" ]; then
 command spack env deactivate "$@";
 else
 if [ -n "$*" ]; then
 command spack env deactivate -h;
 else
 stdout="$(command spack $_sp_flags env deactivate --sh)" || return;
 eval "$stdout";
 fi;
 fi
 ;;
 *)
 command spack env $_sp_arg "$@"
 ;;
 esac;
 fi;
 return
 ;;
 "load" | "unload")
 _a=" $@";
 if [ "${_a#* --sh}" != "$_a" ] || [ "${_a#* --csh}" != "$_a" ] || [ "${_a#* -h}" != "$_a" ] || [ "${_a#* --list}" != "$_a" ] || [ "${_a#* --help}" != "$_a" ]; then
 command spack $_sp_flags $_sp_subcommand "$@";
 else
 stdout="$(command spack $_sp_flags $_sp_subcommand --sh "$@")" || return;
 eval "$stdout";
 fi
 ;;
 *)
 command spack $_sp_flags $_sp_subcommand "$@"
 ;;
 esac
}
BASH_FUNC_ml%%=() {  eval $($LMOD_DIR/ml_cmd "$@")
}
_=/usr/bin/printenv
compilers:
- compiler:
    spec: gcc@8.5.0
    paths:
      cc: /usr/bin/gcc
      cxx: /usr/bin/g++
      f77: /usr/bin/gfortran
      fc: /usr/bin/gfortran
    flags:
      cflags: -O2 -march=native
      cxxflags: -O2 -march=native
      fflags: -O2 -march=native
    operating_system: rocky8
    target: x86_64
    modules: []
    environment: {}
    extra_rpaths: []
config:
  install_tree:
    root: $spack/opt/spack
    projections:
      all: ${ARCHITECTURE}/${COMPILERNAME}-${COMPILERVER}/${PACKAGE}-${VERSION}-${HASH}
  template_dirs:
  - $spack/share/spack/templates

  # Temporary locations Spack can try to use for builds.
  #
  # Recommended options are given below.
  #
  # Builds can be faster in temporary directories on some (e.g., HPC) systems.
  # Specifying `$tempdir` will ensure use of the default temporary directory
  # (i.e., ``$TMP` or ``$TMPDIR``).
  #
  # Another option that prevents conflicts and potential permission issues is
  # to specify `$user_cache_path/stage`, which ensures each user builds in their
  # home directory.
  #
  # A more traditional path uses the value of `$spack/var/spack/stage`, which
  # builds directly inside Spack's instance without staging them in a
  # temporary space.  Problems with specifying a path inside a Spack instance
  # are that it precludes its use as a system package and its ability to be
  # pip installable.
  #
  # In any case, if the username is not already in the path, Spack will append
  # the value of `$user` in an attempt to avoid potential conflicts between
  # users in shared temporary spaces.
  #
  # The build stage can be purged with `spack clean --stage` and
  # `spack clean -a`, so it is important that the specified directory uniquely
  # identifies Spack staging to avoid accidentally wiping out non-Spack work.
  build_stage:
  - $tempdir/$user/spack-stage
  - $user_cache_path/stage
  # - $spack/var/spack/stage

  # Directory in which to run tests and store test results.
  # Tests will be stored in directories named by date/time and package
  # name/hash.
  test_stage: $user_cache_path/test
  source_cache: $spack/var/spack/cache
  misc_cache: $user_cache_path/cache
  connect_timeout: 10
  verify_ssl: true
  suppress_gpg_warnings: false
  install_missing_compilers: false
  checksum: true
  deprecated: false
  dirty: false
  build_language: C
  locks: true
  url_fetch_method: urllib
  ccache: false
  concretizer: clingo
  db_lock_timeout: 3
  package_lock_timeout: null
  shared_linking: rpath
  allow_sgid: true
  terminal_title: false
  debug: false
  build_jobs: 16
mirrors:
  spack-public: https://mirror.spack.io
modules:
  default:
    'enable:':
    - lmod
    lmod:
      core_compilers:
      - gcc@8.5.0
      hierarchy:
      - mpi
      hash_length: 0
      blacklist_implicits: true
      naming_scheme: '{name}/{version}-{hash:7}'
      projections:
        all: '{name}/{version}-{hash:7}'
      all:
        suffixes:
          +openmp: omp
          threads=openmp: omp
          +ipl64: i64
        environment:
          set:
            '{name}_ROOT': '{prefix}'
      intel:
        environment:
          set:
            INTEL_LICENSE_FILE: 40000@elprado.sdsc.edu:40200@elprado.sdsc.edu
      petsc:
        suffixes:
          +complex: cmplx
      slepc:
        suffixes:
          ^petsc +complex: cmplx
      ^python:
        autoload: direct
      ^ucx:
        autoload: direct
  prefix_inspections:
    lib:
    - LD_LIBRARY_PATH
    lib64:
    - LD_LIBRARY_PATH
    bin:
    - PATH
    man:
    - MANPATH
    share/man:
    - MANPATH
    share/aclocal:
    - ACLOCAL_PATH
    lib/pkgconfig:
    - PKG_CONFIG_PATH
    lib64/pkgconfig:
    - PKG_CONFIG_PATH
    share/pkgconfig:
    - PKG_CONFIG_PATH
    ? ''
    : - CMAKE_PREFIX_PATH

  # These are configurations for the module set named "default"
packages:
  lmod:
    externals:
    - spec: lmod@8.2.4
      prefix: /usr
    buildable: false
  lustre:
    externals:
    - spec: lustre@2.15.2
      prefix: /usr
    buildable: false
  openssl:
    externals:
    - spec: openssl@1.1.1k
      prefix: /usr
    buildable: false
  rdma-core:
    externals:
    - spec: rdma-core@43.0
      prefix: /usr
    buildable: false
  slurm:
    externals:
    - spec: slurm@23.02.7
      prefix: /cm/shared/apps/slurm/current
    buildable: false
  all:
    compiler: [gcc, intel, pgi, clang, xl, nag, fj, aocc]
    providers:
      awk: [gawk]
      blas: [openblas, amdblis]
      D: [ldc]
      daal: [intel-daal]
      elf: [elfutils]
      fftw-api: [fftw, amdfftw]
      flame: [libflame, amdlibflame]
      fuse: [libfuse]
      gl: [mesa+opengl, mesa18, opengl]
      glu: [mesa-glu, openglu]
      glx: [mesa+glx, mesa18+glx, opengl]
      golang: [gcc]
      iconv: [libiconv]
      ipp: [intel-ipp]
      java: [openjdk, jdk, ibm-java]
      jpeg: [libjpeg-turbo, libjpeg]
      lapack: [openblas, amdlibflame]
      lua-lang: [lua, lua-luajit]
      mariadb-client: [mariadb-c-client, mariadb]
      mkl: [intel-mkl]
      mpe: [mpe2]
      mpi: [openmpi, mpich]
      mysql-client: [mysql, mariadb-c-client]
      opencl: [pocl]
      onedal: [intel-oneapi-dal]
      osmesa: [mesa+osmesa, mesa18+osmesa]
      pbs: [openpbs, torque]
      pil: [py-pillow]
      pkgconfig: [pkgconf, pkg-config]
      rpc: [libtirpc]
      scalapack: [netlib-scalapack, amdscalapack]
      sycl: [hipsycl]
      szip: [libaec, libszip]
      tbb: [intel-tbb]
      unwind: [libunwind]
      uuid: [util-linux-uuid, libuuid]
      xxd: [xxd-standalone, vim]
      yacc: [bison, byacc]
      ziglang: [zig]
    permissions:
      read: world
      write: user
repos:
- $spack/var/spack/repos/sdsc
- $spack/var/spack/repos/builtin
upstreams: {}
Input spec
--------------------------------
[    ]  .gcc@10.2.0%gcc@8.5.0~binutils~bootstrap~graphite~nvptx~piclibs~strip

Concretized
--------------------------------
==> Bootstrapping clingo from pre-built binaries
[mkandes@login02 specs]$
```
