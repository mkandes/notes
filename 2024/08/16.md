# Resync the deployment branch of a fork with its upstream

In this example, we start with a existing cloned repo, where a new Spack instance is already under development as feature branch of the deployment branch for this version of Spack. 

```
[mkandes@login01 spack]$ pwd
/home/mkandes/software/spack/repositories/mkandes/spack
[mkandes@login01 spack]$ ls
activate-shared-spack-instance.sh   COPYRIGHT       LICENSE-MIT     README.md
bin                                 DEPLOYMENT.md   NOTICE          SECURITY.md
CHANGELOG.md                        etc             opt             share
configure-shared-spack-instance.sh  lib             pyproject.toml  var
CONTRIBUTING.md                     LICENSE-APACHE  pytest.ini
[mkandes@login01 spack]$ git branch
  sdsc-0.17.3
* sdsc-0.17.3-gh-124-inst-exp-cpu-dev
[mkandes@login01 spack]$ git log -1 --stat
commit f854004d83462a27457f4bf2b7293fc60a9a0866 (HEAD -> sdsc-0.17.3-gh-124-inst-exp-cpu-dev, origin/sdsc-0.17.3-gh-124-inst-exp-cpu-dev)
Author: Marty Kandes <mkandes@sdsc.edu>
Date:   Tue Jul 23 12:20:55 2024 -0700

    Update amdlibflame@3.1-omp % gcc@10.2.0 for exp/0.17.3/cpu/dev
    
    Change #SBATCH --time=48:00:00 to #SBATCH --time=00:30:00, which is the
    wallclock time request for the other amdlibflame spec build scripts for
     gcc@10.2.0.

 .../sdsc/expanse/0.17.3/cpu/dev/specs/gcc@10.2.0/amdlibflame@3.1-omp.sh | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
[mkandes@login01 spack]$ git remote -v
origin	https://github.com/mkandes/spack.git (fetch)
origin	https://github.com/mkandes/spack.git (push)
[mkandes@login01 spack]$
```

First checkout the deployment branch, and then add the remote upstream.

```
[mkandes@login01 spack]$ git checkout sdsc-0.17.3
Updating files: 100% (410/410), done.
Switched to branch 'sdsc-0.17.3'
Your branch is up to date with 'origin/sdsc-0.17.3'.
[mkandes@login01 spack]$ git remote add upstream https://github.com/sdsc/spack.git
[mkandes@login01 spack]$ git branch
* sdsc-0.17.3
  sdsc-0.17.3-gh-124-inst-exp-cpu-dev
[mkandes@login01 spack]$ git remote -v
origin	https://github.com/mkandes/spack.git (fetch)
origin	https://github.com/mkandes/spack.git (push)
upstream	https://github.com/sdsc/spack.git (fetch)
upstream	https://github.com/sdsc/spack.git (push)
[mkandes@login01 spack]$
```

Next, fetch all changes from the upstream.

```
[mkandes@login01 spack]$ git fetch --tags upstream
remote: Enumerating objects: 16388, done.
remote: Counting objects: 100% (5000/5000), done.
remote: Total 16388 (delta 5000), reused 5000 (delta 5000), pack-reused 11388 (from 1)
Receiving objects: 100% (16388/16388), 196.24 MiB | 55.04 MiB/s, done.
Resolving deltas: 100% (9866/9866), completed with 1190 local objects.
From https://github.com/sdsc/spack
 * [new branch]            FASTMath/ATPESC18      -> upstream/FASTMath/ATPESC18
 * [new branch]            FASTMath/ATPESC19      -> upstream/FASTMath/ATPESC19
 * [new branch]            PR/openblas            -> upstream/PR/openblas
 * [new branch]            PR/pymock              -> upstream/PR/pymock
 * [new branch]            add-miniconda3@4.8.2-and-revert-4.7.12.1 -> upstream/add-miniconda3@4.8.2-and-revert-4.7.12.1
 * [new branch]            amklinv/amanzi         -> upstream/amklinv/amanzi
 * [new branch]            ascent                 -> upstream/ascent
 * [new branch]            autotools-cflags       -> upstream/autotools-cflags
 * [new branch]            barry/ceed             -> upstream/barry/ceed
 * [new branch]            boost-intel-toolset    -> upstream/boost-intel-toolset
 * [new branch]            bugfix/buildable-true-override-virtual -> upstream/bugfix/buildable-true-override-virtual
 * [new branch]            bugfix/bz2-libs        -> upstream/bugfix/bz2-libs
 * [new branch]            bugfix/compare-abstract-specs -> upstream/bugfix/compare-abstract-specs
 * [new branch]            bugfix/cray-no-module-preloaded -> upstream/bugfix/cray-no-module-preloaded
 * [new branch]            bugfix/env-activate-only-installed-concrete-specs -> upstream/bugfix/env-activate-only-installed-concrete-specs
 * [new branch]            bugfix/improved-uid-detection -> upstream/bugfix/improved-uid-detection
 * [new branch]            bugfix/m4_sierra_gcc_2 -> upstream/bugfix/m4_sierra_gcc_2
 * [new branch]            bugfix/multiarch-detection -> upstream/bugfix/multiarch-detection
 * [new branch]            bugfix/ordered-compiler-names -> upstream/bugfix/ordered-compiler-names
 * [new branch]            bugfix/sbang-filter-non-ascii-python-3 -> upstream/bugfix/sbang-filter-non-ascii-python-3
 * [new branch]            bugfix/setup-env       -> upstream/bugfix/setup-env
 * [new branch]            bugfix/shasta-hotfix-live-branch -> upstream/bugfix/shasta-hotfix-live-branch
 * [new branch]            bugfix/target-args-cray-compilers -> upstream/bugfix/target-args-cray-compilers
 * [new branch]            cdash/xsdk             -> upstream/cdash/xsdk
 * [new branch]            chain-doc-minor-improvement -> upstream/chain-doc-minor-improvement
 * [new branch]            concretizer            -> upstream/concretizer
 * [new branch]            cray-libsci-and-ver    -> upstream/cray-libsci-and-ver
 * [new branch]            dependabot/github_actions/actions/setup-python-4.6.0 -> upstream/dependabot/github_actions/actions/setup-python-4.6.0
 * [new branch]            dependabot/github_actions/docker/build-push-action-4.0.0 -> upstream/dependabot/github_actions/docker/build-push-action-4.0.0
 * [new branch]            dependabot/github_actions/docker/login-action-2.1.0 -> upstream/dependabot/github_actions/docker/login-action-2.1.0
 * [new branch]            dependabot/github_actions/docker/setup-buildx-action-2.5.0 -> upstream/dependabot/github_actions/docker/setup-buildx-action-2.5.0
 * [new branch]            dependabot/github_actions/docker/setup-qemu-action-2.1.0 -> upstream/dependabot/github_actions/docker/setup-qemu-action-2.1.0
 * [new branch]            develop                -> upstream/develop
 * [new branch]            docs/environment-scopes -> upstream/docs/environment-scopes
 * [new branch]            documentation/asp_based_solver -> upstream/documentation/asp_based_solver
 * [new branch]            eaf/200402-SpackEnvironmentDocs -> upstream/eaf/200402-SpackEnvironmentDocs
 * [new branch]            efischer/190121-SetupEnv -> upstream/efischer/190121-SetupEnv
 * [new branch]            efischer/190923-MultiPackagePrototype -> upstream/efischer/190923-MultiPackagePrototype
 * [new branch]            efischer/docs2         -> upstream/efischer/docs2
 * [new branch]            features/add-buildcache-list-to-database -> upstream/features/add-buildcache-list-to-database
 * [new branch]            features/anonymous_specs-fix -> upstream/features/anonymous_specs-fix
 * [new branch]            features/arch-swapping -> upstream/features/arch-swapping
 * [new branch]            features/cached-cmake-build-system -> upstream/features/cached-cmake-build-system
 * [new branch]            features/cflags-resuse -> upstream/features/cflags-resuse
 * [new branch]            features/cmake_deps    -> upstream/features/cmake_deps
 * [new branch]            features/compil        -> upstream/features/compil
 * [new branch]            features/detect-and-swap-current-python -> upstream/features/detect-and-swap-current-python
 * [new branch]            features/env-improvements-release -> upstream/features/env-improvements-release
 * [new branch]            features/env-pre-cmd   -> upstream/features/env-pre-cmd
 * [new branch]            features/find-linux-compilers-by-module -> upstream/features/find-linux-compilers-by-module
 * [new branch]            features/fix-cc-wrapper -> upstream/features/fix-cc-wrapper
 * [new branch]            features/improved-python-detection -> upstream/features/improved-python-detection
 * [new branch]            features/libs-command  -> upstream/features/libs-command
 * [new branch]            features/make-platform-command-line-option -> upstream/features/make-platform-command-line-option
 * [new branch]            features/more-coverage -> upstream/features/more-coverage
 * [new branch]            features/multi-download -> upstream/features/multi-download
 * [new branch]            features/parallel-mirror -> upstream/features/parallel-mirror
 * [new branch]            features/rstudio       -> upstream/features/rstudio
 * [new branch]            features/sandbox-builds -> upstream/features/sandbox-builds
 * [new branch]            features/setup_py      -> upstream/features/setup_py
 * [new branch]            features/shebang-warning-to-msg -> upstream/features/shebang-warning-to-msg
 * [new branch]            features/solver        -> upstream/features/solver
 * [new branch]            features/spack-mirror-verify -> upstream/features/spack-mirror-verify
 * [new branch]            features/spack-test-add-show-subcommand -> upstream/features/spack-test-add-show-subcommand
 * [new branch]            features/spack-test-hdf5-fix -> upstream/features/spack-test-hdf5-fix
 * [new branch]            features/spack-test-openmpi -> upstream/features/spack-test-openmpi
 * [new branch]            features/spack-test-openmpi-add-tests -> upstream/features/spack-test-openmpi-add-tests
 * [new branch]            features/stat_coral_test -> upstream/features/stat_coral_test
 * [new branch]            features/tty-output    -> upstream/features/tty-output
 * [new branch]            features/view-with-env -> upstream/features/view-with-env
 * [new branch]            features/virtual-packages -> upstream/features/virtual-packages
 * [new branch]            fish-shell-1           -> upstream/fish-shell-1
 * [new branch]            fix_cc                 -> upstream/fix_cc
 * [new branch]            flake8-sha256          -> upstream/flake8-sha256
 * [new branch]            fugaku-cross-compilation -> upstream/fugaku-cross-compilation
 * [new branch]            gh-pages               -> upstream/gh-pages
 * [new branch]            github/pr_templates    -> upstream/github/pr_templates
 * [new branch]            implicit-variables-setup -> upstream/implicit-variables-setup
 * [new branch]            legion-update          -> upstream/legion-update
 * [new branch]            libfabric-191-seems-to-work-on-darwin -> upstream/libfabric-191-seems-to-work-on-darwin
 * [new branch]            mfem                   -> upstream/mfem
 * [new branch]            mfem-updates           -> upstream/mfem-updates
 * [new branch]            mfu-cmake              -> upstream/mfu-cmake
 * [new branch]            mpbelhorn-aomp-3.9.0-wip-patch -> upstream/mpbelhorn-aomp-3.9.0-wip-patch
 * [new branch]            package/archer         -> upstream/package/archer
 * [new branch]            packages/gsl-external-cblas -> upstream/packages/gsl-external-cblas
 * [new branch]            packages/pruners-mpi   -> upstream/packages/pruners-mpi
 * [new branch]            packages/tulip         -> upstream/packages/tulip
 * [new branch]            parse-oneapi-version   -> upstream/parse-oneapi-version
 * [new branch]            pipelines-fix-develop-ambiguity -> upstream/pipelines-fix-develop-ambiguity
 * [new branch]            pipelines-improve-ci-job-label -> upstream/pipelines-improve-ci-job-label
 * [new branch]            proto/sys-packages-old -> upstream/proto/sys-packages-old
 * [new branch]            py-cffi-fix-checksum   -> upstream/py-cffi-fix-checksum
 * [new branch]            py26-bootstrap         -> upstream/py26-bootstrap
 * [new branch]            release_pipeline       -> upstream/release_pipeline
 * [new branch]            releases/v0.10.0       -> upstream/releases/v0.10.0
 * [new branch]            releases/v0.11.0       -> upstream/releases/v0.11.0
 * [new branch]            releases/v0.11.1       -> upstream/releases/v0.11.1
 * [new branch]            releases/v0.11.2       -> upstream/releases/v0.11.2
 * [new branch]            releases/v0.12         -> upstream/releases/v0.12
 * [new branch]            releases/v0.13         -> upstream/releases/v0.13
 * [new branch]            releases/v0.13-hwlloc-master -> upstream/releases/v0.13-hwlloc-master
 * [new branch]            releases/v0.14         -> upstream/releases/v0.14
 * [new branch]            releases/v0.15         -> upstream/releases/v0.15
 * [new branch]            releases/v0.16         -> upstream/releases/v0.16
 * [new branch]            retry_serial           -> upstream/retry_serial
 * [new branch]            revert-4.7.12.1        -> upstream/revert-4.7.12.1
 * [new branch]            sdsc-0.15.4            -> upstream/sdsc-0.15.4
 * [new branch]            sdsc-0.17.1            -> upstream/sdsc-0.17.1
 * [new branch]            sdsc-0.17.2            -> upstream/sdsc-0.17.2
 * [new branch]            sdsc-0.17.3            -> upstream/sdsc-0.17.3
 * [new branch]            sdsc-0.18.0            -> upstream/sdsc-0.18.0
 * [new branch]            sdsc-0.19.1            -> upstream/sdsc-0.19.1
 * [new branch]            separate-wrapper-decorator -> upstream/separate-wrapper-decorator
 * [new branch]            shorten-install-status-help -> upstream/shorten-install-status-help
 * [new branch]            silo-qt4               -> upstream/silo-qt4
 * [new branch]            spacktivate            -> upstream/spacktivate
 * [new branch]            spec-language-ideas    -> upstream/spec-language-ideas
 * [new branch]            spec-parse-inequalities -> upstream/spec-parse-inequalities
 * [new branch]            spec-target-flag-option -> upstream/spec-target-flag-option
 * [new branch]            stacks-debugging       -> upstream/stacks-debugging
 * [new branch]            test-gitlab-check-stays-pending -> upstream/test-gitlab-check-stays-pending
 * [new branch]            test/v0.13-with-fast-environments -> upstream/test/v0.13-with-fast-environments
 * [new branch]            testing/wip_xsdk       -> upstream/testing/wip_xsdk
 * [new branch]            tests/vtk-m-smoke-test-fix -> upstream/tests/vtk-m-smoke-test-fix
 * [new branch]            topic-libSplash160     -> upstream/topic-libSplash160
 * [new branch]            tutorials/advanced_packaging -> upstream/tutorials/advanced_packaging
 * [new branch]            update/ipopt           -> upstream/update/ipopt
 * [new branch]            v-dobrev/extend-default-spec-queries -> upstream/v-dobrev/extend-default-spec-queries
 * [new branch]            vendor-clingo          -> upstream/vendor-clingo
 * [new branch]            z3-bootstrap-2.6       -> upstream/z3-bootstrap-2.6
 * [new branch]            z3-concretizer         -> upstream/z3-concretizer
 ! [rejected]              releases/latest        -> releases/latest  (would clobber existing tag)
[mkandes@login01 spack]$
```

Then merge all changes into the local copy of the deployment branch.

```
[mkandes@login01 spack]$ git merge upstream/sdsc-0.17.3
Already up to date.
[mkandes@login01 spack]$
```

Finally, push all changes back to your fork on GitHub. 

```
[mkandes@login01 spack]$ git push
Username for 'https://github.com': mkandes
Password for 'https://mkandes@github.com': 
Everything up-to-date
[mkandes@login01 spack]$ git push --tags
Everything up-to-date
[mkandes@login01 spack]$
```

# Create a new feature branch and submit a pull request

If you would like to deploy a new Spack config, package, or spec into any production instance at SDSC, you must first submit your changes to the deployment branch for the target version of Spack as a pull request. This process begins with creating a new feature branch off of a resynchonized deployment branch. Once the deployment branch is resynchonized, create your feature branch.

```
[mkandes@login01 spack]$ git branch
* sdsc-0.17.3
  sdsc-0.17.3-gh-124-inst-exp-cpu-dev
[mkandes@login01 spack]$ git checkout -b sdsc-0.17.3-gh-125-spec-exp-cpu-pgi-netcdf
Switched to a new branch 'sdsc-0.17.3-gh-125-spec-exp-cpu-pgi-netcdf'
[mkandes@login01 spack]$ git checkout sdsc-0.17.3-gh-125-spec-exp-cpu-pgi-netcdf
Already on 'sdsc-0.17.3-gh-125-spec-exp-cpu-pgi-netcdf'
[mkandes@login01 spack]$ git branch
  sdsc-0.17.3
  sdsc-0.17.3-gh-124-inst-exp-cpu-dev
* sdsc-0.17.3-gh-125-spec-exp-cpu-pgi-netcdf
[mkandes@login01 spack]$
```

As shown above, please label each feature branch with a reference to the GitHub issue it is intended to address. In this case, the feature branch will address GitHub issue https://github.com/sdsc/spack/issues/125, which requires a set of Spack specs to build and install PGI-compiled versions of the NetCDF libraries within the `expanse/0.17.3/cpu/b` instance.

