# How to install and test new Spack package prior to production deployment

```
[mkandes@login02 training-accounts]$ ./reset-home-dirs.sh 
Check if there exists a HOME directory for username spack_dev_cpu ...
/home/spack_dev_cpu exists.
Reset /home/spack_dev_cpu ...
Remove all regular directories ...
cm/
Remove all regular files ...
spack-bootstrap-new-instance.sh
spack-install.sh
Remove all hidden directories ...
.config/
.ssh/
Copy /etc/skel files to /home/spack_dev_cpu ...
.bash_logout
.bash_profile
.bashrc
.emacs
.kshrc
.zshrc
/home/spack_dev_cpu has been reset successfully.
Check if there exists a HOME directory for username spack_dev_gpu ...
/home/spack_dev_gpu exists.
Reset /home/spack_dev_gpu ...
Remove all regular directories ...
Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



No regular directories found.
Remove all regular files ...
Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



No regular files found.
Remove all hidden directories ...
Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



.config/
.ssh/
Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



Copy /etc/skel files to /home/spack_dev_gpu ...
.bash_logout
.bash_profile
.bashrc
.emacs
.kshrc
.zshrc
Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



Lmod has detected the following error: These module(s) or extension(s) exist
but cannot be loaded as requested: "gcc"
   Try: "module spider gcc" to see how to load the module(s).



/home/spack_dev_gpu has been reset successfully.
[mkandes@login02 training-accounts]$
```

```
[mkandes@login02 ~]$ sudo -u spack_dev_cpu ssh login02
Welcome to Bright release         9.0

                                                         Based on Rocky Linux 8
                                                                    ID: #000002

--------------------------------------------------------------------------------

                                 WELCOME TO
                  _______  __ ____  ___    _   _______ ______
                 / ____/ |/ // __ \/   |  / | / / ___// ____/
                / __/  |   // /_/ / /| | /  |/ /\__ \/ __/
               / /___ /   |/ ____/ ___ |/ /|  /___/ / /___
              /_____//_/|_/_/   /_/  |_/_/ |_//____/_____/

--------------------------------------------------------------------------------

Use the following commands to adjust your environment:

'module avail'            - show available modules
'module add <module>'     - adds a module to your environment for this session
'module initadd <module>' - configure module to be loaded at every login

-------------------------------------------------------------------------------
Last login: Mon Jul  7 15:11:53 2025 from 198.202.100.14
[spack_dev_cpu@login02 ~]$
```

```
[spack_dev_cpu@login02 ~]$ cat configure-shared-spack-instance.sh 
#!/usr/bin/env bash
#
# Configure a shared Spack instance in your local ~/.spack directory.

declare -xr SHARED_SPACK_VERSION='0.21.2'
declare -xr SHARED_SPACK_INSTANCE_NAME='cpu'
declare -xr SHARED_SPACK_INSTANCE_VERSION='dev'
declare -xr SHARED_SPACK_ROOT="/cm/shared/apps/spack/${SHARED_SPACK_VERSION}/${SHARED_SPACK_INSTANCE_NAME}/${SHARED_SPACK_INSTANCE_VERSION}"

declare -xr LOCAL_SPACK_NAMESPACE="${USER}"
declare -xr LOCAL_SPACK_TMPDIR='/tmp'
declare -xr LOCAL_SPACK_ROOT="${HOME}/.spack/${SHARED_SPACK_VERSION}/${SHARED_SPACK_INSTANCE_NAME}/${SHARED_SPACK_INSTANCE_VERSION}"

module reset
module list
. "${SHARED_SPACK_ROOT}/share/spack/setup-env.sh"
printenv

mkdir -p "${LOCAL_SPACK_ROOT}"

mkdir -p "${LOCAL_SPACK_ROOT}/var/spack/repos/${LOCAL_SPACK_NAMESPACE}/packages"
tee -a "${LOCAL_SPACK_ROOT}/var/spack/repos/${LOCAL_SPACK_NAMESPACE}/repo.yaml" << EOF
repo:
  namespace: ${LOCAL_SPACK_NAMESPACE}
EOF

mkdir -p "${LOCAL_SPACK_ROOT}/var/spack/stage"
mkdir -p "${LOCAL_SPACK_ROOT}/var/spack/cache"
mkdir -p "${LOCAL_SPACK_ROOT}/share/spack/modules"
mkdir -p "${LOCAL_SPACK_ROOT}/share/spack/lmod"
mkdir -p "${LOCAL_SPACK_ROOT}/opt/spack"

architecture='${ARCHITECTURE}'
compilername='${COMPILERNAME}'
compilerver='${COMPILERVER}'
package='${PACKAGE}'
version='${VERSION}'
hash='${HASH}'

mkdir -p  "${LOCAL_SPACK_ROOT}/etc/spack"
tee -a "${LOCAL_SPACK_ROOT}/config.yaml" << EOF
config:
  install_tree: 
    root: ${LOCAL_SPACK_ROOT}opt/spack
    projections:
      all: ${architecture}/${compilername}-${compilerver}/${package}-${version}-${hash}
  template_dirs:
    - ${SHARED_SPACK_ROOT}/share/spack/templates
  module_roots:
    tcl: ${LOCAL_SPACK_ROOT}share/spack/modules
    lmod: ${LOCAL_SPACK_ROOT}share/spack/lmod
  build_stage:
    - ${LOCAL_SPACK_ROOT}var/spack/stage
    - ${LOCAL_SPACK_TMPDIR}/${USER}/spack-stage
  source_cache: ${LOCAL_SPACK_ROOT}var/spack/cache
  misc_cache: ~/.spack/cache
  connect_timeout: 10
  verify_ssl: true
  suppress_gpg_warnings: false
  install_missing_compilers: false
  checksum: true
  dirty: false
  build_language: C
  locks: true
  build_jobs: 1
  ccache: false
  db_lock_timeout: 3
  package_lock_timeout: null
  shared_linking: 'rpath'
  allow_sgid: true
EOF

tee -a "${LOCAL_SPACK_ROOT}/repos.yaml" << EOF
repos:
  - ${LOCAL_SPACK_ROOT}var/spack/repos/${LOCAL_SPACK_NAMESPACE}
EOF

tee -a "${LOCAL_SPACK_ROOT}/upstreams.yaml" << EOF
upstreams:
  spack-instance-1:
    install_tree: ${SHARED_SPACK_ROOT}/opt/spack
EOF
[spack_dev_cpu@login02 ~]$
```

