# How to install and test new Spack package prior to production deployment

In this example, we will consider the installation of the OneAPI compiler package in the spack/0.21.2/cpu/dev instance, which is already deployed on Expanse.

```
[mkandes@login02 ~]$ ls /cm/shared/apps/spack/0.21.2/cpu/dev/
bin           COPYRIGHT  LICENSE-APACHE  opt             README.md    var
CHANGELOG.md  etc        LICENSE-MIT     pyproject.toml  SECURITY.md
CITATION.cff  lib        NOTICE          pytest.ini      share
[mkandes@login02 training-accounts]$
```

Reset your *_test user account before testing new package install.

```
[mkandes@login02 training-accounts]$ ./reset-home-dirs.sh 
Check if there exists a HOME directory for username mkandes_test ...
/home/mkandes_test exists.
Reset /home/mkandes_test ...
Remove all regular directories ...
PIN+Yubi: 
No regular directories found.
Remove all regular files ...
No regular files found.
Remove all hidden directories ...
.ssh/
Copy /etc/skel files to /home/mkandes_test ...
.bash_logout
.bash_profile
.bashrc
.emacs
.kshrc
.zshrc
/home/mkandes_test has been reset successfully.
[mkandes@login02 training-accounts]$
```

Login to your *_test account.

```
[mkandes@login02 ~]$ sudo -u mkandes_test ssh login02
Welcome to Bright release         9.0

                                                         Based on Rocky Linux 8
                                                                    ID: #000002

--------------------------------------------------------------------------------

                                 WELCOME TO
                  _______  __ ____  ___    _   _______ ______
                 / ____/ |/ // __ \/   |  / | / / ___// ____/
                / __/  |   // /_/ / /| | /  |/ /\__ \/ __/
               / /___ /   |/ ____/ ___ |/ /|  /___/ / /___
              /_____//_/|_/_/   /_/  |_/_/ |_//____/_____/

--------------------------------------------------------------------------------

Use the following commands to adjust your environment:

'module avail'            - show available modules
'module add <module>'     - adds a module to your environment for this session
'module initadd <module>' - configure module to be loaded at every login

-------------------------------------------------------------------------------
[mkandes_test@login02]~% ls -lahtr
total 151K
-rw-r--r--    1 mkandes_test ddp386  75 Jul 29  2021 .gitconfig
-rw-r--r--    1 mkandes_test ddp386 376 Aug  2  2022 .bashrc
-rw-r--r--    1 mkandes_test ddp386 141 Aug  2  2022 .bash_profile
-rw-r--r--    1 mkandes_test ddp386  18 Aug  2  2022 .bash_logout
-rw-r--r--    1 mkandes_test ddp386 658 Sep 29  2022 .zshrc
-rw-r--r--    1 mkandes_test ddp386 334 Apr 12  2023 .emacs
-rw-r--r--    1 mkandes_test ddp386 172 Aug 25  2023 .kshrc
-rw-------    1 mkandes_test ddp386 24K Sep  4  2024 .bash_history
-rw-r--r--    1 mkandes_test ddp386 46K Apr 21 18:00 .zcompdump
-rw-------    1 mkandes_test ddp386 12K May 15 19:55 .viminfo
-rw-------    1 mkandes_test ddp386  49 May 15 20:01 .lesshst
drwxr-xr-x 1931 root         root     0 Jul  7 14:32 ..
drwxr-x---    2 mkandes_test ddp386  13 Jul  7 14:32 .
[mkandes_test@login02]~%
```

Download the latest version of the script to configure a shared spack instance.

```
[mkandes_test@login02]~% wget https://raw.githubusercontent.com/sdsc/spack/refs/heads/sdsc-0.17.3/configure-shared-spack-instance.sh 
--2025-07-07 14:42:04--  https://raw.githubusercontent.com/sdsc/spack/refs/heads/sdsc-0.17.3/configure-shared-spack-instance.sh
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.108.133, 185.199.110.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2505 (2.4K) [text/plain]
Saving to: ‘configure-shared-spack-instance.sh’

configure-shared-sp 100%[===================>]   2.45K  --.-KB/s    in 0s      

2025-07-07 14:42:05 (69.5 MB/s) - ‘configure-shared-spack-instance.sh’ saved [2505/2505]

[mkandes_test@login02]~% cat configure-shared-spack-instance.sh 
#!/usr/bin/env bash
#
# Configure a shared Spack instance in your local ~/.spack directory.

declare -xr SHARED_SPACK_VERSION='0.17.3'
declare -xr SHARED_SPACK_INSTANCE_NAME='cpu'
declare -xr SHARED_SPACK_INSTANCE_VERSION='b'
declare -xr SHARED_SPACK_ROOT="/cm/shared/apps/spack/${SHARED_SPACK_VERSION}/${SHARED_SPACK_INSTANCE_NAME}/${SHARED_SPACK_INSTANCE_VERSION}"

declare -xr LOCAL_SPACK_NAMESPACE="${USER}"
declare -xr LOCAL_SPACK_TMPDIR='/tmp'
declare -xr LOCAL_SPACK_ROOT="${HOME}/.spack/${SHARED_SPACK_VERSION}/${SHARED_SPACK_INSTANCE_NAME}/${SHARED_SPACK_INSTANCE_VERSION}/${SHARED_SPACK_USER}"

module reset
module list
. "${SHARED_SPACK_ROOT}/share/spack/setup-env.sh"
printenv

mkdir -p "${LOCAL_SPACK_ROOT}"

mkdir -p "${LOCAL_SPACK_ROOT}/var/spack/repos/${LOCAL_SPACK_NAMESPACE}/packages"
tee -a "${LOCAL_SPACK_ROOT}/var/spack/repos/${LOCAL_SPACK_NAMESPACE}/repo.yaml" << EOF
repo:
  namespace: ${LOCAL_SPACK_NAMESPACE}
EOF

mkdir -p "${LOCAL_SPACK_ROOT}/var/spack/stage"
mkdir -p "${LOCAL_SPACK_ROOT}/var/spack/cache"
mkdir -p "${LOCAL_SPACK_ROOT}/share/spack/modules"
mkdir -p "${LOCAL_SPACK_ROOT}/share/spack/lmod"
mkdir -p "${LOCAL_SPACK_ROOT}/opt/spack"

architecture='${ARCHITECTURE}'
compilername='${COMPILERNAME}'
compilerver='${COMPILERVER}'
package='${PACKAGE}'
version='${VERSION}'
hash='${HASH}'

mkdir -p  "${LOCAL_SPACK_ROOT}/etc/spack"
tee -a "${LOCAL_SPACK_ROOT}/config.yaml" << EOF
config:
  install_tree: 
    root: ${LOCAL_SPACK_ROOT}opt/spack
    projections:
      all: ${architecture}/${compilername}-${compilerver}/${package}-${version}-${hash}
  template_dirs:
    - ${SHARED_SPACK_ROOT}/share/spack/templates
  module_roots:
    tcl: ${LOCAL_SPACK_ROOT}share/spack/modules
    lmod: ${LOCAL_SPACK_ROOT}share/spack/lmod
  build_stage:
    - ${LOCAL_SPACK_ROOT}var/spack/stage
    - ${LOCAL_SPACK_TMPDIR}/${USER}/spack-stage
  source_cache: ${LOCAL_SPACK_ROOT}var/spack/cache
  misc_cache: ~/.spack/cache
  connect_timeout: 10
  verify_ssl: true
  suppress_gpg_warnings: false
  install_missing_compilers: false
  checksum: true
  dirty: false
  build_language: C
  locks: true
  build_jobs: 1
  ccache: false
  db_lock_timeout: 3
  package_lock_timeout: null
  shared_linking: 'rpath'
  allow_sgid: true
EOF

tee -a "${LOCAL_SPACK_ROOT}/repos.yaml" << EOF
repos:
  - ${LOCAL_SPACK_ROOT}var/spack/repos/${LOCAL_SPACK_NAMESPACE}
EOF

tee -a "${LOCAL_SPACK_ROOT}/upstreams.yaml" << EOF
upstreams:
  spack-instance-1:
    install_tree: ${SHARED_SPACK_ROOT}/opt/spack
EOF
[mkandes_test@login02]~%
```
