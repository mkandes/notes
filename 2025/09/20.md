# How to run JupyterLab with conda and/or virtual environments at OSC

```
(app_jupyter/4.1.5) (app_jupyter/4.1.5) cat ~support/classroom/tools/create_jupyter_kernel
#!/usr/bin/env bash

trap "echo -e '\nCreating Jupter kernel is terminated!\n'; exit 1" TERM INT
trap on_exit EXIT

# Quit if any function returns an non-zero status.
set -eE
set -o pipefail

_header() {
  echo -e "\e[1;32m\n## $*\e[0m"
}

_warn() {
  echo >&2 -e "\e[1;33m:: $*\e[0m"
}

_error() {
  echo >&2 -e "\e[1;31m:: $*\e[0m"
}

_die() {
  echo
  _error $*
  echo
  exit 1
}

on_exit() {
  status=$?
  if [ $status -eq 0 ] ; then
     _header "Jupyter kernel is successfully created"
  else
     echo
     _error "Failed to create Jupter kernel\n"
  fi
}

help() {
  script="`dirname $(readlink -f $0)`"/"$(basename $0)"
  cat << EOF 

Usage: $script < conda | venv >  < conda_name | conda_path | virtualenv_path > [ display_name ] [ kernel_prefix ] [ python_path ]

# Conda environment created by
# conda create -n MYENV
$script conda MYENV

# Conda environment created by
# conda create -p /path/to/MYENV
$script conda /path/to/MYENV

# Virtual environment created by
# python3 -m venv /path/to/MYENV
$script venv /path/to/MYENV
EOF
  exit -1
}

env_type=$1
env_path=$2
display_name=$3
kernel_prefix=$4
python_path=$5

if [ "${env_type}" != "conda" ] && [ "${env_type}" != "venv" ]; then
  help
fi

if [ "x${env_path}" = "x" ]; then
  help
fi

if [ "${env_type}" = "conda" ]; then
   _header "Activating Conda environment"
   cmd="source activate ${env_path}"
   echo $cmd
   eval $cmd
   _header "Checking ipykernel"
   if [[ "$(conda list -f --json ipykernel)" == "[]" ]]; then
       _warn "Cannot find ipykernel packages. Attempting to intall ipykernel"
       _warn "If it fails, please install it manually"
       _header "Installing ipykernel"
       set -x
       CONDA_PKGS_DIRS="$(mktemp -d)" conda install --yes --quiet --no-update-deps pip
       PIP_CACHE_DIR="$(mktemp -d)" pip install --no-cache-dir --no-color --quiet ipykernel
       set +x
   fi
else
   _header "Activating Python virtual environment"
   cmd="source ${env_path}/bin/activate"
   echo $cmd
   eval $cmd
   _header "Checking ipykernel"
   # Force stdin, stdout and stderr to be totally unbuffered. 
   # See https://unix.stackexchange.com/questions/182537/write-python-stdout-to-file-immediately
   python -u -m pip list --local --no-color --format freeze |& grep -i ipykernel && echo no trap > /dev/null
   if [ $? -ne 0 ]; then 
      _header "Installing ipykernel"
      set -x
      PIP_CACHE_DIR="$(mktemp -d)" pip install --no-cache-dir --no-color --quiet ipykernel
      set +x
   fi
fi

_header "Creating Jupyter kernel"
env_name=$(basename $env_path)
kernel_name=${display_name:-"${env_type}_${env_name}"}
display_name=${display_name:-"$env_name [$env_path]"}
kernel_prefix=${kernel_prefix:-}
prefix="--user"
if [ "x$kernel_prefix" != "x" ]; then
   if [ ! -d "$kernel_prefix" ]; then
      _die "The prefix direcotry $kernel_prefix is NOT found"
   fi 
   prefix="--prefix $kernel_prefix"
fi
#env="--env LD_LIBRARY_PATH ${env_path}/lib:\$LD_LIBRARY_PATH"
env=""
if [ "x${python_path}" != "x" ]; then
   if [ ! -d "$python_path" ]; then
      _die "The add-on PYTHONPATH $python_path is NOT found"
   fi 
   env="$env --env PYTHONPATH $python_path"
fi

set -x
python -m ipykernel install $prefix \
  --name "${kernel_name}" \
  --display-name "$display_name" $env
set +x
(app_jupyter/4.1.5) (app_jupyter/4.1.5) 
```

# Reference(s):
- https://www.osc.edu/resources/getting_started/howto/howto_use_jupyter_on_ondemand
- https://www.osc.edu/resources/getting_started/howto/howto_use_a_condavirtual_environment_with_jupyter
- https://www.osc.edu/resources/getting_started/howto/howto_add_python_packages_using_the_conda_package_manager
