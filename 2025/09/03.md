# Setting up perfSONAR on JS2

```
root@perfsonar-archive:~# cat 3by3.json 
{
    "archives": {
        "3by3-archive":{
           "archiver":"http",
           "data":{
              "schema":3,
              "_url":"https://perfsonar-archive.js2local/logstash",
              "verify-ssl":false,
              "op":"put",
              "_headers":{
                 "x-ps-observer":"{% scheduled_by_address %}",
                 "content-type":"application/json"
        }
      }
     }
    },
    "addresses": {
       "host-1": { "address": "perfsonar-testpoint-0.js2local" },
       "host-2": { "address": "perfsonar-testpoint-1.js2local" },
       "host-3": { "address": "perfsonar-testpoint-2.js2local" }
    },
    "groups": {
        "Mesh": {
            "type": "mesh",
            "addresses": [
                { "name": "host-1" },
                { "name": "host-2" },
                { "name": "host-3" }
            ]
         },
        "disjoint-mesh": {
            "type": "disjoint",
	    "unidirectional": true,
            "a-addresses": [
                { "name": "host-1" }
             ],
	    "b-addresses": [
                { "name": "host-2" },
                { "name": "host-3" }
            ]
         }
     },
    "tests": {
       "test_rtt": {
            "type": "rtt",
            "spec": {
                "source": "{% address[0] %}",
                "dest": "{% address[1] %}",
                "count": 10,
                "interval": "PT1S",
                "length": 1000
            }
        },
       "test_latencybg": {
            "type": "latencybg",
            "spec": {
                "source": "{% address[0] %}",
                "dest": "{% address[1] %}",
 	        "packet-interval": 0.1,
 	        "packet-count": 600,
                "flip": "{% flip %}"
            }
        },
       "test_throughput": {
            "type": "throughput",
            "spec": {
                "source": "{% address[0] %}",
		"dest": "{% address[1] %}",
		"reverse": true,
                "duration": "PT20S"
            }
        },
       "test_trace": {
            "type": "trace",
            "spec": {
                "source": "{% address[0] %}",
                "dest": "{% address[1] %}"
            }
        }
    },
    "schedules": {
        "30Min_schedule_PT30M": {
            "repeat": "PT30M",
            "sliprand": true,
            "slip": "PT10M"
        },
        "10Min_schedule_PT10M": {
            "repeat": "PT10M",
            "sliprand": true,
            "slip": "PT10M"
        }
    },
    "tasks": {
        "test_rtt": {
            "group": "Mesh",
            "test": "test_rtt",
            "schedule": "10Min_schedule_PT10M",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-task_rtt",
            "display-task-group": [ "ps-3x3" ]
            }
        },
        "test_latencybg": {
            "group": "Mesh",
            "test": "test_latencybg",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-task_latencybg",
            "display-task-group": [ "ps-3x3" ]
            }
        },
        "test_throughput": {
            "group": "Mesh",
            "test": "test_throughput",
	    "tools": [ "iperf3" ],
            "schedule": "30Min_schedule_PT30M",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-task_throughput",
            "display-task-group": [ "ps-3x3" ]
            }
        },
        "test_trace": {
            "group": "Mesh",
            "test": "test_trace",
            "schedule": "10Min_schedule_PT10M",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-task_trace",
            "display-task-group": [ "ps-3x3" ]
            }
        },
        "test_rtt-dj": {
            "group": "disjoint-mesh",
            "test": "test_rtt",
            "schedule": "10Min_schedule_PT10M",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-DJ-task_rtt",
            "display-task-group": [ "ps-dj-1-3-1by2" ]
            }
        },
        "test_latencybg-dj": {
            "group": "disjoint-mesh",
            "test": "test_latencybg",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-DJ-task_latencybg",
            "display-task-group": [ "ps-dj-1-3-1by2" ]
            }
        },
        "test_throughput-dj": {
            "group": "disjoint-mesh",
            "test": "test_throughput",
	    "tools": [ "iperf3" ],
            "schedule": "30Min_schedule_PT30M",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-DJ-task_throughput",
            "display-task-group": [ "ps-dj-1-3-1by2" ]
            }
        },
        "test_trace-dj": {
            "group": "disjoint-mesh",
            "test": "test_trace",
            "schedule": "10Min_schedule_PT10M",
            "archives": [
                 "3by3-archive"
            ],
        "reference": {
            "display-task-name": "PS5-DJ-task_trace",
            "display-task-group": [ "ps-dj-1-3-1by2" ]
            }
        }
     }
  }
root@perfsonar-archive:~#
```

```
root@perfsonar-archive:~# curl -s https://downloads.perfsonar.net/install | sh -s - --auto-updates \
--add perfsonar-grafana \
--add perfsonar-grafana-toolkit \
--add perfsonar-psconfig-hostmetrics \
--add perfsonar-psconfig-publisher \
archive /root/3by3.json 

#
# Starting perfSONAR installation 2025-09-03T18:58:26
#


#
# Installing prerequisites
#

Reading package lists...
Building dependency tree...
Reading state information...
curl is already the newest version (7.81.0-1ubuntu1.20).
curl set to manually installed.
software-properties-common is already the newest version (0.99.22.9).
software-properties-common set to manually installed.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
...
Get:1 https://downloads.perfsonar.net/debian perfsonar-release/main amd64 perfsonar-psconfig-hostmetrics all 5.2.1-1 [6396 B]
Fetched 6396 B in 0s (15.0 kB/s)
Selecting previously unselected package perfsonar-psconfig-hostmetrics.
(Reading database ... 118796 files and directories currently installed.)
Preparing to unpack .../perfsonar-psconfig-hostmetrics_5.2.1-1_all.deb ...
Unpacking perfsonar-psconfig-hostmetrics (5.2.1-1) ...
Setting up perfsonar-psconfig-hostmetrics (5.2.1-1) ...
Created symlink /etc/systemd/system/multi-user.target.wants/psconfig-hostmetrics-agent.service → /lib/systemd/system/psconfig-hostmetrics-agent.service.
NEEDRESTART-VER: 3.5
NEEDRESTART-KCUR: 6.8.0-79-generic
NEEDRESTART-KEXP: 6.8.0-79-generic
NEEDRESTART-KSTA: 1

perfsonar-psconfig-publisher:

Reading package lists...
Building dependency tree...
Reading state information...
The following NEW packages will be installed:
  perfsonar-psconfig-publisher
0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
Need to get 5524 B of archives.
After this operation, 29.7 kB of additional disk space will be used.
Get:1 https://downloads.perfsonar.net/debian perfsonar-release/main amd64 perfsonar-psconfig-publisher all 5.2.1-1 [5524 B]
Fetched 5524 B in 0s (24.8 kB/s)
Selecting previously unselected package perfsonar-psconfig-publisher.
(Reading database ... 118805 files and directories currently installed.)
Preparing to unpack .../perfsonar-psconfig-publisher_5.2.1-1_all.deb ...
Unpacking perfsonar-psconfig-publisher (5.2.1-1) ...
Setting up perfsonar-psconfig-publisher (5.2.1-1) ...
apache2_invoke ssl: already enabled
apache2_invoke default-ssl: already enabled
apache2_invoke: Enable configuration apache-psconfig-publisher
NEEDRESTART-VER: 3.5
NEEDRESTART-KCUR: 6.8.0-79-generic
NEEDRESTART-KEXP: 6.8.0-79-generic
NEEDRESTART-KSTA: 1

#
# Setting up pSConfig remotes
#

/root/3by3.json:
=== Grafana Agent ===
Added remote configuration /root/3by3.json

=== HostMetrics Agent ===
Added remote configuration /root/3by3.json



Installation completed successfully.

Output logged to /root/install-perfsonar-2025-09-03T18:58:26
root@perfsonar-archive:~#
```

```
root@perfsonar-testpoint-0:~# vi 3by3.json
root@perfsonar-testpoint-0:~# wget https://raw.githubusercontent.com/preese/Step-by-step-to-perfSONAR-TPs-Archive/refs/heads/main/3by3.json
--2025-09-03 19:02:48--  https://raw.githubusercontent.com/preese/Step-by-step-to-perfSONAR-TPs-Archive/refs/heads/main/3by3.json
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.110.133, 185.199.108.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5384 (5.3K) [text/plain]
Saving to: ‘3by3.json’

3by3.json           100%[===================>]   5.26K  --.-KB/s    in 0s      

2025-09-03 19:02:48 (42.7 MB/s) - ‘3by3.json’ saved [5384/5384]

root@perfsonar-testpoint-0:~# vi 3by3.json 
root@perfsonar-testpoint-0:~# curl -s https://downloads.perfsonar.net/install  | sh -s - \
--auto-updates --security testpoint /root/3by3.json 

#
# Starting perfSONAR installation 2025-09-03T19:10:39
#


#
# Installing prerequisites
#

Reading package lists...
Building dependency tree...
Reading state information...
curl is already the newest version (7.81.0-1ubuntu1.20).
curl set to manually installed.
software-properties-common is already the newest version (0.99.22.9).
software-properties-common set to manually installed.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
...
Setting up firewalld (1.1.1-1ubuntu1) ...
update-alternatives: using /usr/share/polkit-1/actions/org.fedoraproject.FirewallD1.server.policy.choice to provide /usr/share/polkit-1/actions/org.fedoraproject.FirewallD1.policy (org.fedoraproject.FirewallD1.policy) in auto mode
Created symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service → /lib/systemd/system/firewalld.service.
Created symlink /etc/systemd/system/multi-user.target.wants/firewalld.service → /lib/systemd/system/firewalld.service.
Setting up perfsonar-toolkit-security (5.2.1-1) ...
Adding perfSONAR firewall rules
Processing triggers for man-db (2.10.2-1) ...
Processing triggers for dbus (1.12.20-2ubuntu4.1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.10) ...
NEEDRESTART-VER: 3.5
NEEDRESTART-KCUR: 6.8.0-79-generic
NEEDRESTART-KEXP: 6.8.0-79-generic
NEEDRESTART-KSTA: 1

#
# Setting up pSConfig remotes
#

/root/3by3.json:
=== pScheduler Agent ===
Added remote configuration /root/3by3.json



Installation completed successfully.

Output logged to /root/install-perfsonar-2025-09-03T19:10:39
root@perfsonar-testpoint-0:~#
```

```
root@perfsonar-archive:~# cat /etc/apache2/conf-enabled/apache-logstash.conf 
<IfModule proxy_module>
    ProxyRequests Off
    <Proxy *>
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order deny,allow
            Allow from all
        </IfVersion>
    </Proxy>

    ProxyPass /logstash http://localhost:11283 status=+I
    ProxyPassReverse /logstash http://localhost:11283 status=+I
    ProxyPreserveHost On

    <Location /logstash>
        Authtype Basic
        Authname "Logstash Pass"
        AuthUserFile /etc/perfsonar/opensearch/logstash_login
        <RequireAny>
           ##################
           ## Require a valid username and password
           Require valid-user

           ###################
           ## Enable IP based or hostname authentication as an alternative to username/pass
           ## The RequireAny means that as long as one of these match then writing will be allowed
           ## There are are many options, some of which are shown below but for full docs see
           ## https://httpd.apache.org/docs/2.4/howto/access.html
           ##
           ## Examples:
           ##
           ## Allow access from IPs 10.1.1.1 and 10.1.1.2
           ## or 2001:db8::a00:20ff:fea7:ccea
           ##
           # Require ip 10.1.1.1 10.1.1.2
           # Require ip 2001:db8::a00:20ff:fea7:ccea
           ##
           ## Allow access from subnet 10.1.1.0/24
           ## or subnet 2001:db8:2:1::/64
           ##
           # Require ip 10.1.1.0/24
           Require ip 10.0.113.0/24
           # Require ip 2001:db8:2:1::/64
           ##
           ## Allow access from a host named  example.perfsonar.net
           # Require host example.perfsonar.net
           ##
           ## Allow access from any host with a name ending in .edu or .gov
           ##
           # Require host gov edu
        </RequireAny>
    </Location>
</IfModule>
root@perfsonar-archive:~# systemctl restart apache2
root@perfsonar-archive:~# systemctl status apache2
● apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
     Active: active (running) since Wed 2025-09-03 19:18:18 UTC; 7s ago
       Docs: https://httpd.apache.org/docs/2.4/
    Process: 13285 ExecStart=/usr/sbin/apachectl start (code=exited, status=0/SUCCESS)
   Main PID: 13290 (apache2)
      Tasks: 71 (limit: 35881)
     Memory: 58.9M
        CPU: 564ms
     CGroup: /system.slice/apache2.service
             ├─13290 /usr/sbin/apache2 -k start
             ├─13291 "elmond           " -k start
             ├─13292 "host_exporter    " -k start
             ├─13293 /usr/sbin/apache2 -k start
             └─13294 /usr/sbin/apache2 -k start

Sep 03 19:18:18 perfsonar-archive systemd[1]: Starting The Apache HTTP Server...
Sep 03 19:18:18 perfsonar-archive apachectl[13289]: [Wed Sep 03 19:18:18.812397 2025] [proxy:warn] [pid 13289:tid 127157823248256] AH01146: Ignoring param>
Sep 03 19:18:18 perfsonar-archive systemd[1]: Started The Apache HTTP Server.
root@perfsonar-archive:~#
```

```
root@perfsonar-archive:~# psconfig publish 3by3.json

Success! File saved to /usr/lib/perfsonar/web-psconfig/3by3.json
Published file can be accessed at https://perfsonar-archive/psconfig/3by3.json
Execute the following on a host running an agent to use this file:
    psconfig remote add "https://perfsonar-archive/psconfig/3by3.json"

root@perfsonar-archive:~#
```

```
root@perfsonar-archive:~# psarchive troubleshoot --skip-opensearch-data
OpenSearch running ...... OK
Logstash running ...... OK
OpenSearch API (Localhost) ...... OK
Logstash Endpoint (Localhost) ...... OK
OpenSearch API (HTTPS Proxy) ...... OK
Logstash Proxy Credentials ...... OK
Logstash Endpoint (HTTPS Proxy) ...... OK
Logstash->OpenSearch Credentials ...... OK
Logstash->OpenSearch Authentication ...... OK
root@perfsonar-archive:~#
```

```
root@perfsonar-testpoint-0:~# psconfig remote add "https://perfsonar-archive/psconfig/3by3.json"
=== pScheduler Agent ===
Added remote configuration https://perfsonar-archive/psconfig/3by3.json
root@perfsonar-testpoint-0:~# pscheduler troubleshoot
Performing basic troubleshooting of perfsonar-testpoint-0.

perfsonar-testpoint-0:

  Checking that host "perfsonar-testpoint-0" resolves... 10.0.113.184
  Measuring MTU... N/A (Local)
  Looking for pScheduler... OK.
  Fetching API level... 6
  Checking clock... OK.
  Exercising API... Archivers... Contexts... Tests... Tools... OK.
  Fetching service status... OK.
  Checking services... Ticker... Scheduler... Runner... Archiver... OK.
  Checking limits... OK.
  Last run scheduled... Never
  Last run completed... Never
  Idle test.... 9 seconds... Finished... Checking archiving... OK.

pScheduler appears to be functioning normally.
root@perfsonar-testpoint-0:~#
```

```
https://149.165.154.129/grafana
```

```
root@perfsonar-archive:~# systemctl stop apache2
root@perfsonar-archive:~# systemctl status apache2
○ apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
     Active: inactive (dead) since Wed 2025-09-03 21:43:03 UTC; 1min 40s ago
       Docs: https://httpd.apache.org/docs/2.4/
    Process: 13285 ExecStart=/usr/sbin/apachectl start (code=exited, status=0/SUCCESS)
    Process: 14165 ExecStop=/usr/sbin/apachectl graceful-stop (code=exited, status=0/SUCCESS)
   Main PID: 13290 (code=exited, status=0/SUCCESS)
        CPU: 12.367s

Sep 03 19:18:18 perfsonar-archive systemd[1]: Starting The Apache HTTP Server...
Sep 03 19:18:18 perfsonar-archive apachectl[13289]: [Wed Sep 03 19:18:18.812397 2025] [proxy:warn] [pid 13289:tid 127157823248256] AH01146: Ignoring param>
Sep 03 19:18:18 perfsonar-archive systemd[1]: Started The Apache HTTP Server.
Sep 03 21:42:57 perfsonar-archive systemd[1]: Stopping The Apache HTTP Server...
Sep 03 21:42:57 perfsonar-archive apachectl[14167]: [Wed Sep 03 21:42:57.676037 2025] [proxy:warn] [pid 14167:tid 133882590988160] AH01146: Ignoring param>
Sep 03 21:43:03 perfsonar-archive systemd[1]: apache2.service: Deactivated successfully.
Sep 03 21:43:03 perfsonar-archive systemd[1]: Stopped The Apache HTTP Server.
Sep 03 21:43:03 perfsonar-archive systemd[1]: apache2.service: Consumed 12.367s CPU time.
root@perfsonar-archive:~#
```

```
# Require ip 10.0.113.0/24
```

# Reference(s):
- https://github.com/preese/Step-by-step-to-perfSONAR-TPs-Archive
- https://downloads.perfsonar.net/install
- https://www.youtube.com/watch?v=XkR5T6GYxIA
