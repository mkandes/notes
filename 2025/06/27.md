# How to install and run MLCFlow (on Expanse)

Let's use a JupyterLab session on Expanse for our development environment. 
You can launch a JupyterLab session on Exapsne with [galyleo](https://github.com/mkandes/galyleo). 
First, you need to put the location of galyleo in your [PATH](https://en.wikipedia.org/wiki/PATH_(variable)) environment variable.

*Command*:
```
export PATH="/cm/shared/apps/sdsc/galyleo:${PATH}"
```

*Output*:
```
[mkandes@login01 ~]$ export PATH="/cm/shared/apps/sdsc/galyleo:${PATH}"
[mkandes@login01 ~]$ echo $?
0
[mkandes@login01 ~]$
```

Once galyleo is in your PATH, you can run its launch command to create your JupyterLab session. 
For the REHS project this summer, we are targeting Expanse's GPU-accelerated compute nodes for our MLPerf Inference Benchmarks.
As such, we'll start by grabing a JupyterLab session on one of Expanse's gpu-debug nodes. 
But first, we need to define our software environment. 
Use the following conda environment yaml file as your starting point for developing a software environment that is compatible with MLCFlow and your specific MLPerf Inference Benchamrk.

```
name: mlcflow-dev

channels:
  - conda-forge
  - nvidia

dependencies:
  - python=3.9
  - pip
  - jupyterlab
  - cudatoolkit=11.8
  - cudnn
```

Create a copy of this yaml file in your [HOME](https://en.wikipedia.org/wiki/Home_directory) directory on Expanse.

```
[mkandes@login01 ~]$ echo $HOME
/home/mkandes
[mkandes@login01 ~]$ ls
data  mlcflow-dev.yaml  projects  references  scripts  software  tmp
[mkandes@login01 ~]$ cat mlcflow-dev.yaml 
name: mlcflow-dev

channels:
  - conda-forge
  - nvidia

dependencies:
  - python=3.9
  - pip
  - jupyterlab
  - cudatoolkit=11.8
  - cudnn
[mkandes@login01 ~]$
```

You're now ready to launch the JupyterLab session with this initial development environment.
Run the following galyleo launch command. Don't forget to change your account.

*Command*:
```
galyleo launch --account abc123 --partition gpu-debug --cpus 10 --memory 92 --gpus 1 --time-limit 00:30:00 --conda-yml mlcflow-dev.yaml
```

*Output*:
```
[mkandes@login01 ~]$ galyleo launch --account use300 --partition gpu-debug --cpus 10 --memory 92 --gpus 1 --time-limit 00:30:00 --conda-yml mlcflow-dev.yaml 
Preparing galyleo for launch into Jupyter orbit ...
Listing all launch parameters ...
  command-line options       : values
    -A | --account           : use300
    -R | --reservation       : 
    -p | --partition         : gpu-debug
    -q | --qos               : 
    -N | --nodes             : 1
    -c | --cpus              : 10
    -m | --memory            : 92 GB
    -g | --gpus              : 1
       | --gres              : 
    -t | --time-limit        : 00:30:00
    -C | --constraint        : 
    -i | --interface         : lab
    -d | --notebook-dir      : 
       | --scratch-dir       : "/scratch/${USER}/job_${SLURM_JOB_ID}"
    -e | --env-modules       : singularitypro
       | --append-modulepath : 
    -s | --sif               : 
    -B | --bind              : 
       | --nv                : 
       | --conda-init        : 
       | --conda-env         : 
       | --conda-yml         : /home/mkandes/mlcflow-dev.yaml
       | --conda-version     : latest
       | --mamba             : false
       | --cache             : false
       | --spark-home        : 
       | --disable-checklist : false
       | --checklist-timeout : 10 s
    -Q | --quiet             : 1
Your token is 
catatonic-supplier-gush
200
Generating Jupyter launch script ...
md5sum: mlcflow-dev.md5: No such file or directory
Submitted Jupyter launch script to Slurm. Your SLURM_JOB_ID is 40678928.
Success! Token linked to jobid.
Please copy and paste the HTTPS URL provided below into your web browser.
Do not share this URL with others. It is the password to your Jupyter notebook session.
Your Jupyter notebook session will begin once compute resources are allocated to your job by the scheduler.
https://catatonic-supplier-gush.expanse-user-content.sdsc.edu/?token=c006deeb55b1e399fcc84fb09c8e4218
[mkandes@login01 ~]$
```



# Reference(s):
- https://docs.mlcommons.org/mlcflow/
