# Evaluating `reset-home-dirs.sh` on a particularly complicated `HOME` dir and `zsh` environment

Before ...

```
   ~  45 ···································· ✔  base   at 10:20:56 AM 
ls -lahtr
total 764K
drwxr-xr-x   3 croy ddp195    6 Oct 13  2019 .subversion
drwxr-xr-x  10 croy ddp195   10 Jun 24  2020 lib
drwxr-xr-x   5 croy ddp195    5 Aug  6  2020 .ipython
drwxr-xr-x   3 croy ddp195    5 Aug  6  2020 .allinea
drwx------   3 croy ddp195    3 Aug 10  2020 .singularity
-rw-r--r--   1 croy ddp195  236 Oct 20  2020 .bash_profile
drwxr-xr-x   6 croy ddp195    7 Oct 20  2020 .rustup
drwxr-xr-x   4 croy ddp195    6 Oct 20  2020 .cargo
drwxr-xr-x   2 croy ddp195    4 Oct 25  2020 .aws
-rw-r--r--   1 croy ddp195  134 Jun 15  2021 .zprofile
drwxr-xr-x   5 croy ddp195    7 Jun 24  2021 .jupyter
drwxr-xr-x   2 croy ddp195    2 Jul 14  2021 .git
drwxr-xr-x   2 croy ddp195    5 Jul 31  2021 .ipynb_checkpoints
drwx------   2 croy ddp195    9 Oct  2 10:33 .ssh
drwxr-xr-x   5 croy csd750    7 Oct  2 10:33 .dotfiles
lrwxrwxrwx   1 croy csd750   27 Oct  2 12:32 .bashrc -> .dotfiles/stow/bash/.bashrc
lrwxrwxrwx   1 croy csd750   29 Oct  2 12:32 .gitconfig -> .dotfiles/stow/git/.gitconfig
lrwxrwxrwx   1 croy csd750   29 Oct  2 12:32 .p10k.zsh -> .dotfiles/stow/p10k/.p10k.zsh
lrwxrwxrwx   1 croy csd750   30 Oct  2 12:32 .tmux.conf -> .dotfiles/stow/tmux/.tmux.conf
lrwxrwxrwx   1 croy csd750   35 Oct  2 12:32 .visidatarc -> .dotfiles/stow/visidata/.visidatarc
lrwxrwxrwx   1 croy csd750   33 Oct  2 12:32 .zshenv -> .dotfiles/stow/zsh_ubuntu/.zshenv
drwxr-xr-x   3 croy ddp195   56 Oct  2 13:03 bin
drwxr-xr-x   8 croy ddp195    8 Oct  2 13:27 .local
-rw-r--r--   1 croy csd750 9.0K Oct  2 13:34 tmux-client-1148479.log
drwxr-xr-x   6 croy ddp195    7 Oct  2 13:37 .npm
drwxr-xr-x  11 croy ddp195   20 Oct  2 14:05 .navi
drwxr-xr-x   3 croy csd750    3 Oct  3 09:40 CCBB
drwxr-xr-x   4 croy csd750    5 Oct  7 12:16 .directory_history
drwxr-xr-x   9 croy ddp195   15 Oct 14 16:41 .config
drwxrwxr-x   3 croy csd750    6 Oct 14 16:55 .conda
-rw-r--r--   1 croy csd750   50 Oct 14 16:58 .condarc
drwxr-xr-x   3 croy csd750    3 Oct 14 17:19 .mamba
drwx------   3 croy csd750    3 Oct 14 18:51 .nv
drwxr-xr-x   2 croy csd750    3 Oct 14 18:51 .keras
drwxr-xr-x  18 croy csd750   26 Oct 26 14:19 miniconda3
-rw-------   1 croy ddp195 1.3M Oct 26 16:37 .bash_history
drwxr-xr-x   4 croy csd750    4 Oct 27 09:29 .ood_portal
drwx------   2 croy csd750   13 Oct 27 09:45 .galyleo
drwxr-xr-x  13 croy ddp195   22 Oct 27 18:26 .oh-my-zsh
-rw-r--r--   1 croy csd750  167 Oct 27 18:34 .wget-hsts
drwxr-xr-x  37 croy ddp195   71 Oct 28 10:13 tools
drwxr-xr-x   6 croy csd750    8 Oct 28 10:22 .cpan
drwxr-xr-x  17 croy ddp195   21 Oct 29 10:18 .cache
drwxr-xr-x   7 croy csd750   35 Oct 29 10:19 tmp
drwxr-xr-x 399 root root      0 Oct 29 10:20 ..
-rw-------   1 croy ddp195 914K Oct 29 10:20 .zsh_history
drwxr-x---  34 croy ddp195   47 Oct 29 10:20 .

   ~  45 ············································· ✔  base   with croy@login02  81.2G   global   at 10:20:58 AM 
```

Current version of the script ...

```
#!/usr/bin/env bash
#
# Reset each training account's HOME directory to its default 
# configuration prior to the start of a workshop or after the workshop 
# has concluded.

declare -xr HOSTNAME_FQDN="$(hostname -f)"

readarray -t users <<< "$(cat users.txt)"
for user in "${users[@]}"; do

  echo "Check if there exists a HOME directory for username ${user} ..."
  if [[ ! -d "/home/${user}" ]]; then
    echo "ERROR: /home/${user} does not exist."
    exit 1
  else
    echo "/home/${user} exists."
  fi

  echo "Reset /home/${user} ..."
  echo 'Remove all regular directories ...'
  sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} ls -p "/home/${user}" | grep /
  if [[ "${?}" -eq 0 ]]; then
    readarray -t regular_dirs <<< "$(sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} ls -p | grep /)"
    for regular_dir in "${regular_dirs[@]}"; do
      sudo -u ${user} ssh ${user}@${HOSTNAME_FQDN} rm -rf "/home/${user}/${regular_dir}"
      if [[ "${?}" -ne 0 ]]; then
        echo "ERROR: Failed to rm -rf /home/${user}/${regular_dir}"
        exit 1
      fi
    done
  else
    echo 'No regular directories found.'
  fi

  echo 'Remove all regular files ...'
  sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} ls -p "/home/${user}" | grep -v /
  if [[ "${?}" -eq 0 ]]; then
    readarray -t regular_files <<< "$(sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} ls -p "/home/${user}" | grep -v /)"
    for regular_file in "${regular_files[@]}"; do
      sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} rm -f "/home/${user}/${regular_file}"
      if [[ "${?}" -ne 0 ]]; then
        echo "ERROR: Failed to rm -f /home/${user}/${regular_file}"
        exit 1
      fi
    done
  else
    echo 'No regular files found.'
  fi

  echo 'Remove all hidden directories ...'
  sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} ls -pA "/home/${user}" | grep /
  if [[ "${?}" -eq 0 ]]; then
    readarray -t hidden_dirs <<< "$(sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} ls -pA "/home/${user}" | grep /)"
    for hidden_dir in "${hidden_dirs[@]}"; do
      sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} rm -rf "/home/${user}/${hidden_dir}"
      if [[ "${?}" -ne 0 ]]; then
        echo "ERROR: Failed to rm -rf /home/${user}/${hidden_dir}"
        exit 1
      fi
    done
  else
    echo 'No hidden directories found.'
  fi

  echo "Copy /etc/skel files to /home/${user} ..."
  ls -pA /etc/skel | grep -v /
  if [[ "${?}" -eq 0 ]]; then
    readarray -t skel_files <<< "$(ls -pA /etc/skel | grep -v /)"
    for skel_file in "${skel_files[@]}"; do
      sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} cp -p "/etc/skel/${skel_file}" "/home/${user}/${skel_file}"
      if [[ "${?}" -ne 0 ]]; then
        echo "ERROR: Failed to cp -p /etc/skel/${skel_file} /home/${user}/${skel_file}"
        exit 1
      fi
    done
  else
    echo 'No skeleton files found.'

# Delete last line of ~/.bashrc file: module load gcc
  #sudo -u ${user} ssh -o "StrictHostKeyChecking no" -q ${user}@${HOSTNAME_FQDN} sed -i '\$d' "/home/${user}/.bashrc"

  echo "/home/${user} has been reset successfully."

done
```

Initial run ... failed. Processes appear to still be running from user and holding on to file handles.

```
vi re[mkandes@login02 training-accounts]$ vi reset-home-dirs.sh 
[mkandes@login02 training-accounts]$ ./reset-home-dirs.sh 
Check if there exists a HOME directory for username croy ...
/home/croy exists.
Reset /home/croy ...
Remove all regular directories ...
PIN+Yubi: 
CCBB/
bin/
lib/
miniconda3/
tmp/
tools/
PIN+Yubi: 
rm: cannot remove '/home/croy/tmp/.nfs000000002280ad7c00012fb4': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs000000002280082b00012d25': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7aaa0001050f': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7aa30001050c': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs000000002244e2fc0000fd40': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs0000000001321f8c00010522': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7ab600010512': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs000000002250b4200000fbd5': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs000000000156fc4700014167': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs0000000001518f1d0000fc0d': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000224aeb4500010d99': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs000000002250aa420000fba8': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7a9d0001050b': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs000000002250d4700000fbfa': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7ab000010511': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7aa20001050e': Device or resource busy
rm: cannot remove '/home/croy/tmp/.nfs00000000226f7b0600010514': Device or resource busy
ERROR: Failed to rm -rf /home/croy/tmp/
[mkandes@login02 training-accounts]$
```

Killing off stale processes around ...

```
   ~  41 ················································· ✔  at 11:16:51 AM 
pkill -9 -u $USER
Killed
[mkandes@login02 training-accounts]$
```

Second attempt at reset ... failed at the end ...

```
[mkandes@login02 training-accounts]$ ./reset-home-dirs.sh 
Check if there exists a HOME directory for username croy ...
/home/croy exists.
Reset /home/croy ...
Remove all regular directories ...
tmp/
tools/
Remove all regular files ...
tmux-client-1148479.log
Remove all hidden directories ...
.allinea/
.aws/
.cache/
.cargo/
.conda/
.config/
.cpan/
.directory_history/
.dotfiles/
.galyleo/
.git/
.ipynb_checkpoints/
.ipython/
.jupyter/
.keras/
.local/
.mamba/
.navi/
.npm/
.nv/
.oh-my-zsh/
.ood_portal/
.rustup/
.singularity/
.ssh/
.subversion/
Copy /etc/skel files to /home/croy ...
.bash_logout
.bash_profile
.bashrc
.emacs
.kshrc
.zshrc
cp: not writing through dangling symlink '/home/croy/.bashrc'
ERROR: Failed to cp -p /etc/skel/.bashrc /home/croy/.bashrc
[mkandes@login02 training-accounts]$
```
